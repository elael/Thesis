\section{Simulation}

Works on \textit{computacional ocean
acoustics}, the subfield of knowledge that explores the algorithms that model
the ocean as an acoustic medium, are well documented by
\citet{Etter2013}. Most of these works focus on very long range simulations,
with its most important features been the ocean floor and sub-bottom region.

This work aim to reconstruct and simulate near-range partially closed
environments, as those created by humans. The motivation for such a choice comes
from hydroeletrict power plant water intake, it is a corridor-like environment
with possible obstacles on the bottom. This kind of envirnoment is not well
covered on the underwater acoustics literature, as such, some of the simulations
techniques are borrowed from the closelly related are of \textit{room acoustics}.

When constructing a simulation one has to consider the tradeoff between
simplicity/perfomance/accuracy. There are several possible techniques with
different applications and assumptions, this chapter will cover the most
classic ones and further explore \textit{ray theory}, which has been used for
the simulation presented here. For a more comprehensive view on this and other
techniques, see \citet{LURTON,jensen2011computational}.

\subsection{Techniques Overview}
\label{ss:simuloverview}

The idea behind sound simulation techniques is to solve the wave
equation (eq. \ref{eq:wave}) considering all the physical interfaces as boundary
conditions. The equation, however, cannot be analitically solved due to common
present discontinuities caused by occlusions, specular highlights and other
facts that result in large variations of the field over small regions of the
domain of integration\cite{funkhouser2003survey}.

The single most important reason that differentiate the several approches
described here is the \textit{wave frequency}. For high-frequency (where sound
speed do not very much in a wavelength scale) geometric methods (ray theory) are
justifiable and preferable (in the computational sense) \cite{urick1979}. In the
case of low/mid - frequency or in the presence of caustics\footnote{A region of
high constructive interference that geometrically gives a point of infinity
rays convegence.} other wave methods (e.g. finite elements, normal modes,
parabolic approximation) should be applied.

Instead of using the full wave equation, the methods work with a simplified
time-independ version. It starts by assuming that the equation
\ref{eq:wave}:

\[ \nabla^2 p = \frac{1}{c^2_0}\frac{\partial^2}{\partial t^2} p \]

Has a solution where time dependence is a harmonic function:

\[ p(\coord{x},t) = \Re(\psi(\coord{x})e^{-i\omega t}) \]

Here $\coord{x}$ is the space coordinate while $t$ the time. The exponential function
considered is the complex exponetial with $i$ been the imaginary unit. The
real part $\Re(\parm)$ is taken as $p$ is real valued, but $\phi(\coord{x})$ is a
complex valued function over space.
%\[ \frac{\partial}{\partial t}\psi = 0 \]
%\[ \nabla^2 \vartheta = 0 \]

Substituting it back into equation \ref{eq:wave}, gives
(dropping explicit parameters again):

\[ \Re(\nabla^2 \psi e^{-i\omega t}) =
\Re(-(\tfrac{\omega}{c_0})^2 \psi e^{-i\omega t})\]

% \[ \frac{\nabla^2 \psi}{\psi} = \frac{1}{c_0^2\vartheta} \frac{\partial^2}{\partial
% t^2}\vartheta  \]

Defining $k \equiv \tfrac{\omega}{c_0} $ (a.k.a. the wave number) and rearanging
terms:

\[ \Re((\nabla^2 \psi -k^2 \psi) e^{-i\omega t}) = 0\]

As the harmonic $e^{-i\omega t}$ is equivalent to a rotation in the complex
plane, the equation will be satisfied for all $t$ if:

\begin{equation}
\label{eq:helmholtz}
(\nabla^2 -k^2)\psi = 0 
\end{equation}

%  As the expressions on
% both sides vary indepently, ie.
% l.h.s.
% varies with space $x$ and r.h.s. with time $t$, they must be constant. As a matter of ajusting the
% equation to fit its stantard parametrization, this constant is chosen to be
% $-k^2$, then:
% 
% \[ \frac{\nabla^2 \psi}{\psi} = -k^2  \]
% \[ \frac{1}{c_0^2\vartheta} \frac{d^2}{dt^2}\vartheta = -k^2  \]
% 
% Or
% 
% \begin{equation}
% \label{eq:helmholtz}
% (\nabla^2 -k^2)\psi = 0 
% \end{equation}
% 
% \[ (\frac{d^2}{dt^2} + (kc_0)^2)\vartheta = 0  \]
% 
% With the apropriate definition of $\omega \equiv kc_0 $ the last equation,
% becomes:
% 
% \begin{equation}
% (\frac{d^2}{dt^2} + \omega^2)\vartheta = 0
% \end{equation}

Equation \ref{eq:helmholtz} is known as the (homogeneous) \textit{Helmholtz
equation} and describe the time-independent part of the wave propagation. The
values of $k$ and $\omega$ can be phisically interpreted as the spatial and
tempral angular frequency of the wave. As the wave equation is a linear
equation superposition applies, it is resoanble to take into consideration
one wave frequency at a time and superpose all these harmonics by Fourier
synthesis\cite{Lefebvre}.

Fourier synthesis is the calculation by \textit{Helmholtz
equation} of each independent frequency: 

\[ \psi_\omega(\coord{x}) = \int_{-\infty}^\infty p(\coord{x},t)e^{i\omega t}\dif t \]

And reconstruct the wave equation back by:

\[ p(\coord{x},t) = \int_{-\infty}^\infty\psi_\omega(\coord{x})e^{-i\omega t}\dif\omega \]

These equations are the inverse and forward Fourier transform, respetively.

\subsubsection{FEM - Finite Element Method}

Finite Element Methods try to numerically find a solution to the wave equation
by discretizing the space, and something time. It considers the equation
\ref{eq:wave} for inside the enviroment and the boundary conditions:

\[  \frac{\partial}{\partial \mathbf{n}}p= -\rho_0 \frac{\partial^2
x_n}{\partial t^2} \quad \text{on the source} \]

\[  c_0 \frac{\partial}{\partial \mathbf{n}}p= - \frac{1-R_c}{1+R_c}
\frac{\partial}{\partial t} p \quad \text{on other interfaces} \]

Where $\mathbf{n}$ is the normal direction of the surface, $\rho_0$ is the
medium density and $x_n$ is the displacement of the acoustic membrane. The
reflection coefficient $R_c$ might depend on the interface, but as FEM are used
for small frequency bands, it is a minor problem\cite{deines2006comparative}.

To create a linear system, the pressure fuction is approximated by a
superposition of functions, e.g. sum of piecewise quadratic functions \(
p(\coord{x},t)= \sum_{i=0}^N p_i(t) \varphi_i(\coord{x}) \), applied to the wave and boundary
equation and integrated w.r.t. $\varphi_i$. Giving a large set of ordinary
differential equations:

\begin{align*}
M\ddot{p} + D\dot{p} + Kp &= Fu \\
y &= Pp
\end{align*}

With \(M,D,K\) being \(N \times N \) matrices, $p$ being the vector with
coeficients $p_i$, $Fu$ the input converted into a force and $P$ some selection
matrix to ouput the pressure on the desired points. This model can be writen and
solved as generalized state-space model:

\begin{align*}
E\dot{\hat{x}} &= A\hat{x} + Bu \\
y &= C\hat{x}
\end{align*}

\[
\hat{x} =
  \begin{bmatrix}
    p \\
    \dot{p}
  \end{bmatrix},~
E =
  \begin{bmatrix}
    I & 0 \\
    0 & M
  \end{bmatrix},~
A =
  \begin{bmatrix}
    0 & I \\
    -K & -D
  \end{bmatrix},~
B =
  \begin{bmatrix}
    0 \\
    F
  \end{bmatrix}
  ~
  \text{and}
  ~
C =
  \begin{bmatrix}
    P & 0 
  \end{bmatrix}
\]
 
 There can be made more simplification, but it is enough to highlight the
 limitations of the method (For more details, refer to
 \citet{deines2006comparative}). The dimension of the state is related to
 the number of functions used to approximate $N$ (two times without any further
 simplification) that depends on the frequency:
 
 \[N = \left(\frac{nLf}{c_0}\right)^3 \]
 
 Where $L$ is a typical dimension in the environment, $f = \frac{\omega}{2\pi}$
 the frequency and $n$ the number of elements per wave, that should be 3 ou 4
 for a good approximation\cite{deines2006comparative}.
 
 Given that the size of the state increases as the cube of the frequency, the
 technique can only be applied to low-frequency signals, which is not applicable
 to high-frequency sonar as envisoned by this work. 

There is also a boundary method that use surface integral form of the wave
equation, but suffer from similar restrictions. \citet{funkhouser2003survey}
gives a brief introduction of the subject.

\subsubsection{Ray theory}

Geometric approachs like ray theory dates back to Newton and the corpuscular
theory of light. Later found to be better discribed as a wave, the geometric
theory of light still a very important and usefull tool. The sound ray theory
follow a similar path, they both apply to high frequency waves, but typical
sound waves have low/mid-frequency while visible light have a much higher
frequency.

To describe the ray from the wave theory, it starts by solving the Helmholtz
equation (eq \ref{eq:helmholtz}) with a generic complex function of space
through a polar decomposition\cite{buckingham1992ocean,torres2007modeling}:

\[ \psi(\coord{x}) = \mathcal{A}(\coord{x})e^{iw\tau(\coord{x})} \]

Here $\tau(\coord{x})$ can be interpreted as the time it takes for sound to
reach the location $\coord{x}$ and $\mathcal{A}(\coord{x})$ the amplitude of the
signal at that point. Substituting it back to equation \ref{eq:helmholtz} and
separing real and imaginary parts, two equations are obtained (droping
arguments):

\begin{subequations}
\begin{equation}
\label{eq:preeikonal}
\frac{\nabla^2\mathcal{A}}{\mathcal{A}} - (w\nabla \tau)^2 + k^2 = 0
\end{equation}

\begin{equation}
\label{eq:preeikonalamp}
2(\nabla\mathcal{A} \cdot \nabla \tau) + \mathcal{A}\nabla^2 \tau = 0
\end{equation}
\end{subequations}

The geometric approximation is the assumption that the amplitude do not change
much on the wavelenth scale, mathematically expressed as:

\begin{equation}
\label{eq:highfrequency}
\frac{\nabla^2\mathcal{A}}{\mathcal{A}} \ll k^2
\end{equation}

Applying the this approximation to equation \ref{eq:preeikonal} and using the
fact that \(\omega = kc_0 \):

\begin{equation}
\label{eq:eikonal}
\left| \nabla \tau \right| = \frac{1}{c_0}
\end{equation}

The equation \ref{eq:eikonal} is known as the \textit{Eikonal equation} and
defines the sufaces of constant phase. Equation \ref{eq:preeikonalamp}, called
the transport equation, can then br used to find the pressure amplitude of the
wave, but when treating the instensity instead of pressure amplitude conservation of energy can be used, as
will be seen later on subsection \ref{ss:raytheory}.

The rays are, by definition, the perpendicular lines to the wavefronts defined
by equation \ref{eq:eikonal}. Which, if a length parametrization, is:

\begin{equation}
\label{eq:ray}
\frac{\dif r}{\dif s} = c_0 \nabla\tau
\end{equation}

Where $r(s)$ is the path follow by the ray, and $s$ the ray length. To verify
that it is a length parametrization square equation \ref{eq:ray} and use
equation \ref{eq:eikonal} to find:

\[ \left| \frac{\dif r}{\dif s} \right| = 1 \]

Showing that it is a unit norm tangent vetor. To find the ray path, first take
the gradient of equation \ref{eq:eikonal} squared:

\begin{subequations}
\begin{equation*}
\nabla(\left| \nabla \tau \right|^2) = \nabla\left(\frac{1}{c_0^2}\right)
\end{equation*}
\begin{equation*}
2\coord{H}(\tau)\nabla\tau = 2\frac{1}{c_0}\nabla\left(\frac{1}{c_0}\right)
\end{equation*}
\begin{equation}
\label{eq:t_hessiantau}
c_0\coord{H}(\tau)\nabla\tau = \nabla\left(\frac{1}{c_0}\right)
\end{equation}
\end{subequations}

The \(\coord{H}(\parm)\) is the Hessian. Also, the derivative of equation
\ref{eq:ray} (divided by $c_0$) w.r.t.
$s$ is:


\begin{subequations}
\begin{equation*}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\frac{\dif}{\dif s}(\nabla\tau)
\end{equation*}
\begin{equation}
\label{eq:t_dergrad}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\coord{H}(\tau)\frac{\dif r}{\dif s}
\end{equation}
\end{subequations}

Using equation \ref{eq:ray} and \ref{eq:t_hessiantau} in the r.h.s. of equation
\ref{eq:t_dergrad}:

\begin{subequations}
\begin{equation*}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\coord{H}(\tau)(c_0\nabla\tau)
\end{equation*}
\begin{equation}
\label{eq:raydirection}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\nabla\left(\frac{1}{c_0}\right)
\end{equation}
\end{subequations}

The equation \ref{eq:raydirection} can now be integrated to give the ray path.
Considering the important case of constant sound velocity $c_0$ (as assumed
elsewhere in this work):

\[ \nabla\left(\frac{1}{c_0}\right) = 0 \]

So, equation \ref{eq:raydirection} (with equation \ref{eq:ray}) can be easily
solved to:

\begin{equation}
\label{eq:sray}
r(s) = r_0 + (c_0\nabla\tau_0)s
\end{equation}

Where $r_0$ is the ray origin, $\tau_0$ is the gradient of $\tau$ anywhere
along the ray, and the addition is taken with $\mathbb{R}^3$ as an affine space.
This is the equation of a line, show that acoustic rays travel as a straight
line on constant velocity mediums for a high-frequency approximation.

Further considerations on reflection and refraction may rely on the
\textit{Snell law} limilar to the electromagnetic case, because the eikonal
equation is equivalent to the \textit{Fermat's principle of least time}. If
the first variation of the time functional is zero:

\begin{equation*}
\delta T[C] = \delta \int \frac{1}{c_0(\coord{x})}
\left|\coord{x}'\right| \dif s = 0
\end{equation*}

Here $\coord{x}(s)$ is a parametrization of the path $C$, $x'(s)$ the tangent
vector at $s$ and the whole integral $T[\parm]$ is the time to follow the path
$C$. The \textit{Euler-Lagrange equations} give:


\begin{equation*}
\nabla\left(\frac{1}{c_0}\left|\coord{x}'\right|\right) - \frac{\dif}{\dif s}
\nabla'\left(\frac{1}{c_0} \left|\coord{x}'\right|\right) = 0
\end{equation*}

Where $\nabla'$ is the gradient taken on the tangent space contaning
$\coord{x}'$.
Which become:

\begin{equation*}
\left|\coord{x}'\right|\nabla\left(\frac{1}{c_0}\right) =
\frac{\dif}{\dif s}\left( \frac{1}{c_0} \frac{\coord{x}'}{\left|\coord{x}'\right|}\right)
\end{equation*}

By considering a length parametrization $r$ such that $\left|r'\right|=1$, the
result is the same as equation \ref{eq:raydirection}, so all the results follow.

It is important to highlight that the single simplification from the wave
equation was the high-frequency assumption \cite{national1969physics}, given at
equation \ref{eq:highfrequency}. A more complete description of the mathematics
envolving the physics behind ray theory can be found at \citet{Lefebvre}.


\subsubsection{Normal modes}

When there is a prefered direction, or a general axis symetric medium, like the
ocean (which is generally treated as a horizontally stratified medium), a
cylindrical parametrization define a usefull coordinate system. The principal
axis, usually depth, contain the superposition of normal modes while the other
dimensions carrie the traveling wave.

There are slightly different mathematical approachs to Normal Modes Theory on
the literature\cite{Etter2013,urick1979,buckingham1992ocean}. The following
brief description relly on the techniques of \citet{Etter2013}. Writing the
solution of equation \ref{eq:helmholtz} as a product of a ``depth'' (principal
axis) function $N(z)$ and a horizontal range function $H(r)$:

\[ \psi = N(z)H(r) \]

 Leads to a separantion of variables on the ODE, with $k_0$ as separation
 constant: %Yield to
 
 \begin{subequations}
 \begin{equation}
 \label{eq:normalmode}
 \fdif{z}N + (k^2 - k_0^2)N = 0
 \end{equation}
 \begin{equation}
 \label{eq:normaltraveling}
 \fdifn{r}{2}H + \inv{r}\fdif{r}H + k_0^2H = 0
 \end{equation}
 \end{subequations}
 
 The equation \ref{eq:normalmode} describes the pressure field along the depth,
 it is known as the normal mode equation. Equation \ref{eq:normaltraveling}, on
 the other hand, solely describes the traveling portion of the wave, that
 happens in the horizontal direction.
 The full solution for $\psi$ is found by solving both equations. The equation
 \ref{eq:normalmode} is a classic eigenvalue problem for the differential
 operator, whose solutions, including bounderies conditions, are known as
 Green's function $G$ \cite{desanto2012scalar}. The horizontal equation
 \ref{eq:normaltraveling} is a zero-order Bessel equation, so it may have its
 solution written in terms of the zero order Henkel function of the first kind
 ($H_0^{(1)}$)\footnote{$H_0^{(1)}(x) = J_0(x)+iY(x)$, where $J_0$ and $Y_0$
 are the zero-order Bessel functions of first and second order, respectively.
 More details on these functions, see \citet{abramowitz1964handbook}}. Putting
 these solutions together, for a monocromatic point source:
 
 \begin{equation}
 \label{eq:normalmono}
 \psi(z,r) = \int_{-\infty}^{\infty} G(z,z_s;k_0)H_0^{(1)}(k_0r)k_0\dif k_0
 \end{equation}
 
Where $z_s$ is the source position on the principal axis. The evaluation of the
integral as it appears is impractical, thus some simplifications are required.

The Green's function $G$ can be expanded as a bilinear summation of ortonormal
functions ($u_ n$), the \textit{normal modes}\cite{baker2003green}, weighted by
using their respective eigenvalues ($k_n$), the natural frequencies. The real
integral of equation \ref{eq:normalmono} can be evaluated throught \textit{contour
integration} to exploit the residue of the poles present on the natural
frequencies, but that comes with a price, it is necessary to chose a riemann
sheet for the integral and evaluate the branch line integral
separately\cite{jensen2011computational,worzel1948propagation}:

\begin{equation}
\psi = \oint \sum_n{\frac{u_n(z)\overline{u_n(z_s)}}{k^2 -
k_n^2}H_0^{(1)}(k_0r)k_0\dif k_0} + I_{\text{branch-cut}}
\end{equation}

The branch line integral $I_{\text{branch-cut}}$ can be physically interpreted
as the contrubuition of the constinuous mode spectrum (in contrast with the
normal modes), representing modes that propagates through the ocean floor
(being strongly attenuated) and near-field, that decays exponentially with
distance. Assuming that the horizontal distance is several times the water
depth, the branch line term is ignored in most theoretical developments.

Therefore, by assuming a far-field approximation ($k_0r \ll 1$), besides
disregard the branch line integral, it is possible to consider a asymptotic expantions for the
Hankel fucntion and evaluate the contour integral, obtaining\cite{Etter2013}:

\begin{equation}
\label{eq:normalsolution}
\psi =
g(r)\sum_n{\frac{u_n(z)\overline{u_n(z_s)}}{\sqrt{k_n}}e^{i(k_nr-\tfrac{\pi}{4})-\delta_nr}}
\end{equation}

Here $g(r)$ is a general function of the range and $\delta_n$ the attenuation
coefficient. In practice, the summation ranges over only a bounded number of
modes, but this number increases with frequency, which leaves it as undesirable
for high-frequency waves. 

One of the advantages of normal modes over ray theory lies on the fact that, for
each source/receiver position, the ray approach have to run a full simulation of
the rays, while the normal modes have a closed form (like equation
\ref{eq:normalsolution}) that easily adapts to new combinations of these
parameters. In constrast, normal modes are constrained by the source frequency,
in fact by the number of modes to be computed, and generally requires deeper
knowledge of the environment. The the attenuation
coefficient($\delta_n$) in the ocean, for exemple, depends on water absorption,
ocean sediment layer absorptions, compressional and shear attenuation on the
basement, measures of the modes interations with both sediment and
basement(compressional and shear mechanisms) and statistics on the
water-sediment boundary and sea surface as well.

\subsubsection{Parabolic approximation}

The parabolic approximation replaces the Helmholtz equation \ref{eq:helmholtz},
which is a elliptic partial differential equation, by a simplified parabolic
version. This approximation dates back to the middle of the $\mathrm{XXI}$
century, in the context of tropospheric radio wave propagation.

The normal mode solution do not handle well non-stratified medium, to overcome
this limitation parabolic approximation is constructed to handle slow varying
mediums. The variation is made explicit by $k = k_0n(r,z)$, where $n(r,z)$ is a
sound refractive index\cite{LURTON}. The Helmholtz equation becomes:

\begin{equation}
\label{eq:varyhelmholtz}
(\nabla^2 - k_0^2n^2(r,z))\psi = 0 
\end{equation}

The solutions are assumed to have a fast varying horizontal field
$H_0^{(1)}(k_0r)$ and overall slow fluctuations $F(r,z)$:

\begin{equation*}
\psi(r,z) = F(r,z)H_0^{(1)}(k_0r)
\end{equation*}

Assuming asymptotic behavior to the Hankel function (similar to normal modes
development) and applying it to equation \ref{eq:varyhelmholtz}:

\begin{equation}
\label{eq:preparabolic}
\fdifn{r}{2}F + 2ik_0\fdif{r}F + \fdifn{z}{2}F + k_0^2(n^2-1)F = 0
\end{equation}

By the assumption that $F(r,z)$ is a slow varying field, the $\fdifn{r}{2}F$
term is neglected and equation \ref{eq:preparabolic} gives rise to the parabolic
equation. \citet{LURTON} proceeds further by discretizing the horizontal
directions, without defining explicit dependence on the Hankel function, and
using an approximation for the differentials on $z$ through pseudo-differential
operator.

The parabolic equation can then be solved numerically, but the grid size vary
with frequency, becoming costly for high-frequency waves. For more
details, see \citet{jensen2011computational}.

\subsection{Ray Theory}
\label{ss:raytheory}

The Ray Theory provides a good way to treat high-frequency sound propagation,
far from caustics, that retain an intuitive meaning. Introduced in subsection
\ref{ss:simuloverview}, it is very similar to its electromagnetic counterpart.

In a homogeneous or stratified medium, the most important considerations come
from the interation of the rays with the interfaces, namely: \textbf{reflected rays},
\textbf{transmited rays} and \textbf{scattered rays}.

Math issue computability (sugested yes) -
\citet{reif1994computability,blakey2014ray}

rough water surface scattering - \citet{jones2009modelling}

Many materials follow Lambert's law closely in scat-
tering light and it is also a good approximation for
backscattering of sound by rough - \citet{blake1995remote}

Deep BRDF compare with Lambert - \citet{miller2015real}

Analytical BRDF - \citet{durany2015analytical}

Image source, scattering ray theory - \citet{chandak2011fast} 

Image source, Beam tracing - \citet{funkhouser2003survey}

Split scattering/reflection measurement - \citet{vorlander2000definition}

Local acoustic Energy Exchange (but no Lambert) - \citet{rober2007ray}

The room acoustic rendering equation (most of all)- \citet{siltanen2007room}

Backscattering single consideration - \citet{LURTON,Etter2013}

ISO and AES scattering measuring - \citet{rindel2001scattering}

Scattering coefficients (+ too deep) - \citet{cox2006tutorial}

Workflow simulation - \citet{bell1997simulation}

%\subsection{3D Enviroment Specifics}
\subsection{Results}
