\section{Simulation}

\textit{Computational ocean
acoustics} explores algorithms that model
the ocean as an acoustic medium. Works on this matter are well documented by
~\citet{Etter2013}. Most of these works focus on very long range simulations,
with its most important features been the ocean floor and sub-bottom region.

This work aims to reconstruct and simulate near-range partially closed
environments, as those created by humans. The motivation for such a choice comes
from the application on hydroelectric power plant water intakes, which is a
corridor-like environment with possible obstacles on the bottom. This kind of environment is not well
covered on the underwater acoustics literature, as such, some simulations
techniques are borrowed from the closely related area of \textit{room
acoustics}.

When constructing a simulation, one has to consider the trade-off between
simplicity, performance and accuracy. There are several possible techniques with
different applications and assumptions, this chapter will cover the most
classic ones and further explore \textit{ray theory}, which has been used for
the simulation presented here. For a more comprehensive view on this and other
techniques, see~\citet{LURTON,jensen2011computational}.

\subsection{Techniques Overview}
\label{ss:simuloverview}

The idea behind sound simulation techniques is to solve the wave
equation (\ref{eq:wave}) considering all the physical interfaces as
boundary conditions. The equation, however, cannot be analytically solved due to common
present discontinuities caused by occlusions, specular highlights and other
facts that result in large variations of field over small regions of the
domain of integration~\cite{funkhouser2003survey}.

The single most important reason that differentiates the several approaches
described here is the \textit{wave frequency}. For high-frequency (where sound
speed do not vary much in a wavelength scale) geometric methods (ray theory) are
justifiable and preferable (in the computational sense)~\cite{urick1979}. In the
case of low/mid - frequency or in the presence of caustics\footnote{A region of
high constructive interference that geometrically gives a point of infinity
rays convergence.}, other wave methods (e.g. finite elements, normal modes,
parabolic approximation) should be applied.

%% SrJ: aren't you mjissing a subsubsection here ?

%% SrJ: "assumed" ? Isn't that an analytic solution in case of a sine wave
%% SrJ: (fourier transform and all that)
Instead of using the full wave equation, the methods work with a simplified
time-independent version. As it is a linear equation, it can be assumed that the
equation (\ref{eq:wave})

\[ \nabla^2 p = \frac{1}{c^2_0}\frac{\partial^2}{\partial t^2} p \,,\]
%
has a solution where time dependence is an harmonic function, as the standard
method for solving linear differential equations:

\begin{equation}
\label{eq:pressurepsi}
p(\coord{x},t) = \Re(\psi(\coord{x})\mathrm{e}^{-i\omega t})\,,
\end{equation}
%
where $\coord{x}$ is the space coordinate while $t$ is the time and $\omega$
interpreted as angular frequency.
The exponential function considered is the complex exponential with $i$ being the imaginary unit.
The real part $\Re(\parm)$ is taken as $p$ is real-valued, but $\psi(\coord{x})$
is a complex-valued function over space.
%\[ \frac{\partial}{\partial t}\psi = 0 \]
%\[ \nabla^2 \vartheta = 0 \]

Substituting it back into (\ref{eq:wave}), gives
(dropping explicit parameters again):

\[ \Re(\nabla^2 \psi \mathrm{e}^{-i\omega t}) =
\Re(-(\tfrac{\omega}{c_0})^2 \psi \mathrm{e}^{-i\omega t})\]

% \[ \frac{\nabla^2 \psi}{\psi} = \frac{1}{c_0^2\vartheta} \frac{\partial^2}{\partial
% t^2}\vartheta  \]

Defining $k \equiv \tfrac{\omega}{c_0} $ (a.k.a. the wave number) and rearranging
terms:

\[ \Re((\nabla^2 \psi -k^2 \psi) \mathrm{e}^{-i\omega t}) = 0\]

As the harmonic $\mathrm{e}^{-i\omega t}$ is equivalent to a rotation in the
complex plane, the equation will be satisfied for all $t$ if:

\begin{equation}
\label{eq:helmholtz}
(\nabla^2 -k^2)\psi = 0 
\end{equation}

%  As the expressions on
% both sides vary indepently, ie.
% l.h.s.
% varies with space $x$ and r.h.s. with time $t$, they must be constant. As a matter of ajusting the
% equation to fit its stantard parametrization, this constant is chosen to be
% $-k^2$, then:
% 
% \[ \frac{\nabla^2 \psi}{\psi} = -k^2  \]
% \[ \frac{1}{c_0^2\vartheta} \frac{d^2}{dt^2}\vartheta = -k^2  \]
% 
% Or
% 
% \begin{equation}
% \label{eq:helmholtz}
% (\nabla^2 -k^2)\psi = 0 
% \end{equation}
% 
% \[ (\frac{d^2}{dt^2} + (kc_0)^2)\vartheta = 0  \]
% 
% With the apropriate definition of $\omega \equiv kc_0 $ the last equation,
% becomes:
% 
% \begin{equation}
% (\frac{d^2}{dt^2} + \omega^2)\vartheta = 0
% \end{equation}

Equation (\ref{eq:helmholtz}) is known as the (homogeneous) \textit{Helmholtz
equation} and describe the time-independent part of the wave propagation. The
values of $k$ and $\omega$ can be physically interpreted as the spatial and
temporal angular frequency of the wave. As the wave equation is 
linear, superposition applies, being reasonable to take into consideration one
wave frequency at a time and superpose all these harmonics by Fourier synthesis~\cite{Lefebvre}.

Fourier synthesis is the calculation by \textit{Helmholtz
equation} of each independent frequency: 

\[ \psi_\omega(\coord{x}) = \int_{-\infty}^\infty
p(\coord{x},t)\mathrm{e}^{i\omega t}\dif t \,,\]
%
and reconstruct the wave equation back by:

\[ p(\coord{x},t) =
\int_{-\infty}^\infty\psi_\omega(\coord{x})\mathrm{e}^{-i\omega t}\dif\omega
\,.\]

These equations are the inverse and forward Fourier transform, respectively.

\subsubsection{FEM - Finite Element Method}\abbrev{FEM}{Finite Element Method}

Finite Element Methods try to numerically find a solution to the wave equation
by discretizing space, and time in some cases. It considers the equation
(\ref{eq:wave}) for inside the environment and the boundary conditions:

\[  \frac{\partial}{\partial \mathbf{n}}p= -\rho_0 \frac{\partial^2
x_n}{\partial t^2} \quad \text{on the source}\,, \]

\[  c_0 \frac{\partial}{\partial \mathbf{n}}p= - \frac{1-R_c}{1+R_c}
\frac{\partial}{\partial t} p \quad \text{on other interfaces}\,, \]
%
where $\mathbf{n}$ is the normal direction of the surface, $\rho_0$ is the
medium density and $x_n$ is the displacement of the acoustic membrane. The
reflection coefficient $R_c$ might depend on the interface, but as FEM are used
for small frequency bands, it is a minor problem~\cite{deines2006comparative}.

To create a linear system, the pressure function is approximated by a
superposition of functions, e.g. sum of piecewise quadratic functions \(
p(\coord{x},t)= \sum_{i=0}^N p_i(t) \varphi_i(\coord{x}) \), applied to the wave and boundary
equation and integrated w.r.t. $\varphi_i$. Giving a large set of ordinary
differential equations:

\begin{align*}
M\ddot{p} + D\dot{p} + Kp &= Fu \\
y &= Pp
\end{align*}
%
with \(M,D,K\) being \(N \times N \) matrices, $p$ being the vector with
coefficients $p_i$, $Fu$ the input converted into a force and $P$ some selection
matrix to output the pressure on the desired points. This model can be written
and solved as generalized state-space model:

\begin{align*}
E\dot{\hat{x}} &= A\hat{x} + Bu \\
y &= C\hat{x}
\end{align*}

\[
\hat{x} =
  \begin{bmatrix}
    p \\
    \dot{p}
  \end{bmatrix},~
E =
  \begin{bmatrix}
    I & 0 \\
    0 & M
  \end{bmatrix},~
A =
  \begin{bmatrix}
    0 & I \\
    -K & -D
  \end{bmatrix},~
B =
  \begin{bmatrix}
    0 \\
    F
  \end{bmatrix}
  ~
  \text{and}
  ~
C =
  \begin{bmatrix}
    P & 0 
  \end{bmatrix}\,,
\]
 
 There can be made more simplifications, but it is enough to highlight the
 limitations of the method (for more details, refer to
~\citet{deines2006comparative}). The dimension of the state is twice
 the number $N$ of functions used in the approximation and that depends on the
 frequency:
 
 \[N = \left(\frac{nLf}{c_0}\right)^3\,, \]
 %
 where $L$ is a typical dimension in the environment, $f = \frac{\omega}{2\pi}$
 the frequency and $n$ the number of elements per wave, that should be 3 ou 4
 for a good approximation~\cite{deines2006comparative}.
 
 Given that the size of the state increases as the cube of the frequency, the
 technique can only be applied to low-frequency signals, which is not applicable
 to high-frequency sonar as envisioned by this work. 

There is also a boundary method that uses surface integral form of the wave
equation, but suffers from similar restrictions.~\citet{funkhouser2003survey}
gives a brief introduction of the subject.

\subsubsection{Ray theory}
\label{sss:raytheory}

Geometric approaches like ray theory dates back to Newton and the corpuscular
theory of light. Later found to be better described as a wave, the geometric
theory of light is still a very important and useful tool. The sound ray theory
%% SrJ: frequency is irrelevant to using geometry, wavelength is. The
% frequencies
%% SrJ: are different, but because of the speeds the wavelengths are not so much
follows a similar path, they both apply to short-wavelength waves, but typical
sound waves have mid-wavelength ($10$--$10^{-3}$m) while visible light has a
much shorter wavelength ($\approx10^{-6}$m).

To describe the ray from the wave theory, one starts by solving the Helmholtz
equation (\ref{eq:helmholtz}) with a generic complex function of space
through a polar decomposition~\cite{buckingham1992ocean,torres2007modeling}:

\begin{equation}
\label{eq:psi}
\psi(\coord{x}) = \mathcal{A}(\coord{x})\mathrm{e}^{i\omega\tau(\coord{x})}\,.
\end{equation}


Here, $\tau(\coord{x})$ can be interpreted as the time it takes the sound to
reach the location $\coord{x}$ and $\mathcal{A}(\coord{x})$ the amplitude of the
signal at that point. Substituting it back to (\ref{eq:helmholtz}) and
separating real and imaginary parts, two equations can be obtained (omitting
arguments):

\begin{subequations}
\begin{equation}
\label{eq:preeikonal}
\frac{\nabla^2\mathcal{A}}{\mathcal{A}} - (\omega\nabla \tau)^2 + k^2 = 0\,,
\end{equation}

\begin{equation}
\label{eq:preeikonalamp}
2(\nabla\mathcal{A} \cdot \nabla \tau) + \mathcal{A}\nabla^2 \tau = 0\,.
\end{equation}
\end{subequations}

The geometric approximation is the assumption that the amplitude does not change
much on the wavelength scale, mathematically expressed as:

\begin{equation}
\label{eq:highfrequency}
\frac{\nabla^2\mathcal{A}}{\mathcal{A}} \ll k^2\,.
\end{equation}

Applying this approximation to (\ref{eq:preeikonal}) and using the
fact that \(\omega = kc_0 \):

\begin{equation}
\label{eq:eikonal}
\norm{ \nabla \tau } = \frac{1}{c_0}\,.
\end{equation}

The equation (\ref{eq:eikonal}) is known as the \textit{Eikonal equation} and
defines the surfaces of constant phase. Equation (\ref{eq:preeikonalamp}), called
the transport equation, can then be used to find the pressure amplitude of the
wave. However,  when considering intensity, conservation of energy can be used as
will be seen later in Subsection \ref{ss:raytheory}.

The rays are, by definition, the perpendicular lines to the wavefronts defined
by equation (\ref{eq:eikonal}) which, with length parametrization, is:

\begin{equation}
\label{eq:ray}
\frac{\dif r}{\dif s} = c_0 \nabla\tau\,,
\end{equation}
%
where $r(s)$ is the path follow by the ray, and $s$ the ray length. To verify
that it is a length parametrization, one has to square (\ref{eq:ray}) and use
(\ref{eq:eikonal}) to find:

\begin{equation*}
\norm{\frac{\dif r}{\dif s}} = 1\,,
\end{equation*}
%
showing that it is a unit norm tangent vector. To find the ray path, first take
the gradient of (\ref{eq:eikonal}) squared:

\begin{subequations}
\begin{equation}
\nabla(\norm{ \nabla \tau }^2) = \nabla\left(\frac{1}{c_0^2}\right)\,,
\end{equation}
\begin{equation}
2\coord{H}(\tau)\nabla\tau = 2\frac{1}{c_0}\nabla\left(\frac{1}{c_0}\right)\,,
\end{equation}
\begin{equation}
\label{eq:t_hessiantau}
c_0\coord{H}(\tau)\nabla\tau = \nabla\left(\frac{1}{c_0}\right)\,.
\end{equation}
\end{subequations}

\(\coord{H}(\parm)\) is the Hessian. The derivative of
(\ref{eq:ray}) (divided by $c_0$) w.r.t. $s$ is:


\begin{subequations}
\begin{equation}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\frac{\dif}{\dif s}(\nabla\tau)\,,
\end{equation}
\begin{equation}
\label{eq:t_dergrad}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\coord{H}(\tau)\frac{\dif r}{\dif s}\,.
\end{equation}
\end{subequations}

Using (\ref{eq:ray}) and (\ref{eq:t_hessiantau}) in the
r.h.s.\abbrev{r.h.s.}{right hand side} of (\ref{eq:t_dergrad}):

\begin{subequations}
\begin{equation}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\coord{H}(\tau)(c_0\nabla\tau)\,,
\end{equation}
\begin{equation}
\label{eq:raydirection}
\frac{\dif}{\dif s}\left(\frac{1}{c_0}\frac{\dif r}{\dif s}\right)
=\nabla\left(\frac{1}{c_0}\right)\,.
\end{equation}
\end{subequations}

The equation (\ref{eq:raydirection}) can now be integrated to give the ray path.
Considering the important case of constant sound velocity $c_0$ (as assumed
elsewhere in this work):

\[ \nabla\left(\frac{1}{c_0}\right) = 0 \,.\]

So, (\ref{eq:raydirection}) (with (\ref{eq:ray})) can be easily
solved to:

\begin{equation}
\label{eq:sray}
r(s) = r_0 + (c_0\nabla\tau_0)s\,,
\end{equation}

where $r_0$ is the ray origin, $\nabla\tau_0$ is the gradient of $\tau$ anywhere
%% SrJ?: "an affine space" OK, either you go all the way or you don't. You can't
%% SrJ: drop something like this at this point, it's ridiculous
%% SrJ: (my advice is "don't", this is engineering, not math, R^3 is an affine
%% SrJ: space)
%% , and the addition is taken with $\mathbb{R}^3$ as an affine space
along the ray.
This is the equation of a line, which show that acoustic rays travel as a
straight line on constant velocity mediums for a high-frequency approximation.

Further considerations on reflection and refraction may rely on the
\textit{Snell law} similar to the electromagnetic case, because the eikonal
equation is equivalent to the \textit{Fermat's principle of least time}. If
the first variation of the time functional is zero:

\begin{equation*}
\delta T[C] = \delta \int \frac{1}{c_0(\coord{x})}
\norm{\coord{x}'} \dif s = 0\,.
\end{equation*}

Here, $\coord{x}(s)$ is a parametrization of the path $C$, $\coord{x}'(s)$ the
tangent vector at $s$ and the integral $T[\parm]$ is the time to traverse
$C$. The \textit{Euler-Lagrange equations} give


\begin{equation*}
\nabla\left(\frac{1}{c_0}\norm{\coord{x}'}\right) - \frac{\dif}{\dif s}
\nabla'\left(\frac{1}{c_0} \norm{\coord{x}'}\right) = 0\,,
\end{equation*}
%
where $\nabla'$ is the gradient taken on the tangent space containing
$\coord{x}'$, which becomes:

\begin{equation*}
\norm{\coord{x}'}\nabla\left(\frac{1}{c_0}\right) =
\frac{\dif}{\dif s}\left( \frac{1}{c_0}
\frac{\coord{x}'}{\norm{\coord{x}'}}\right)\,.
\end{equation*}

By considering a length parametrization $r$ such that $\norm{r'}=1$, the
result is the same as (\ref{eq:raydirection}), so all the results follow.

It is important to highlight that this simplification relies only on the
high-frequency assumption~\cite{national1969physics}, given at equation
(\ref{eq:highfrequency}). A more complete mathematical description of the physics
behind ray theory can be found at~\citet{Lefebvre}.

An important result, commonly applied on algorithms derived from ray theory, is
the summation of energy/intensity of incoherent rays at a point. It starts by
taking the norm of the intensity (\ref{eq:intensity_pressure}) and applying the
pressure definition to it (\ref{eq:pressurepsi}) to get\footnote{Here,
$\mathbb{E}[\parm]$ means the expectation for clarity.}


\begin{equation}\label{eq:intensity_psi}
I = g_0~\mathbb{E}[\abs{\psi}^2]\,,
\end{equation}
%
where $g_0 = \tfrac{1}{\rho c_0}$ (the inverse of the characteristic impedance),
$I$ the intensity and $\phi$ the wave.
For a single ray, (\ref{eq:psi}) becomes:

\begin{equation*}
I = g_0~\mathbb{E}[\abs{\mathcal{A}}^2]\,.
\end{equation*}

To consider the contribution of a set of incoherent rays $\psi_i$ (i.e.
%% SrJ?: I'm not sure about the "statistically" here ... I believe
% "uncorrelated"
%% SrJ: would be enough given the definition of "uncorrelated waves" in physics
uncorrelated), the total $\psi$ becomes:

\begin{equation}\label{eq:wavesum}
\psi = \sum_i \psi_i \,,
\end{equation}
%
with the established fact that the expected value of a wave is zero (i.e. the
mean pressure variation is zero), the condition
becomes\footnote{Here, $\psi_i^*$ is the complex conjugate of $\psi_i$ for
better reading.}:


\begin{equation}
\label{eq:wave_uncorr}
\text{cov}(\psi_i,\psi_j) = \mathbb{E}[\psi_i \psi_j^*] = 0\,.
\end{equation}

The resulting equation of the intensity (\ref{eq:intensity_psi}) for a
full wave (\ref{eq:wavesum}) is:

\begin{equation*}
\begin{split}
I &= g_0~\mathbb{E}\left[\abs{ \sum_i \psi_i } ^2\right] =
g_0~\mathbb{E}\left[ (\sum_i \psi_i)(\sum_j \psi_j)^*\right] \\
&= g_0~\mathbb{E}\left[\sum_i \abs{\psi_i}^2 + \sum_{i \neq j} \psi_i
\psi_j^*\right] \\
&= g_0~\mathbb{E}\left[\sum_i \abs{\psi_i}^2\right]  +
g_0~\mathbb{E}\left[\sum_{i \neq j} \psi_i \psi_j^*\right] \\
& = g0~\sum_i \mathbb{E}\left[\abs{\psi_i}^2\right]  + g_0~\sum_{i \neq j}
\mathbb{E}[\psi_i \psi_j^*] \\
& = \sum_i g_0\mathbb{E}\left[\abs{\psi_i}^2\right]\,,
\end{split}
\end{equation*}

Which implies:
\begin{equation}
\label{eq:intensity_sum}
I = \sum_i I_i\,.
\end{equation}

This assumption of incoherent rays will be a common point among ray tracing
algorithm, mainly because it implies the summation of ray intensities $I_i$ to a
single intensity. It is a reasonable assumption on mildly complex environments
with diffuse (scattering) surfaces, which is explained by Ray Theory
in Subsection \ref{ss:raytheory}.


\subsubsection{Normal modes}

When there is a preferred direction, or a general axis symmetric medium, like the
ocean (which is generally treated as a horizontally stratified medium), a
cylindrical parametrization becomes a useful coordinate system. The principal
axis, in our case depth, contains the superposition of normal modes while the
other dimensions carry the traveling wave.

There are slightly different mathematical approaches to Normal Modes Theory in
the literature~\cite{Etter2013,urick1979,buckingham1992ocean}. The following
brief description rely on the techniques of~\citet{Etter2013}. Writing the
solution of (\ref{eq:helmholtz}) as a product of a ``depth'' (principal
axis) function $N(z)$ and a horizontal range function $H(r)$:

\[ \psi = N(z)H(r) \,,\]
%
 leads to a separation of variables on the ODE, with $k_0$ as separation
 constant: %Yield to
 
 \begin{subequations}
 \begin{equation}
 \label{eq:normalmode}
 \fdif{z}N + (k^2 - k_0^2)N = 0\,,
 \end{equation}
 \begin{equation}
 \label{eq:normaltraveling}
 \fdifn{r}{2}H + \inv{r}\fdif{r}H + k_0^2H = 0\,.
 \end{equation}
 \end{subequations}
 
 The normal mode equation (\ref{eq:normalmode}) describes the pressure field along
 the depth. Equation (\ref{eq:normaltraveling}), on
 the other hand, describes the traveling portion of the wave, that
 happens in the horizontal plane.
 The full solution for $\psi$ is found by solving both equations. The equation
 (\ref{eq:normalmode}) is a classic eigenvalue problem for the differential
 operator, whose solutions, including boundary conditions, are known as
 Green's function $G$~\cite{desanto2012scalar}. The horizontal equation
 (\ref{eq:normaltraveling}) is a zero-order Bessel equation, so it may have its
 solution written in terms of the zero order Henkel function of the first kind
 ($H_0^{(1)}$)\footnote{$H_0^{(1)}(x) = J_0(x)+iY(x)$, where $J_0$ and $Y_0$
 are the zero-order Bessel functions of first and second order, respectively.
 More details on these functions, see~\citet{abramowitz1964handbook}.}. Putting
 these solutions together, for a monochromatic point source:
 
 \begin{equation}
 \label{eq:normalmono}
 \psi(z,r) = \int_{-\infty}^{\infty} G(z,z_s;k_0)H_0^{(1)}(k_0r)k_0\dif k_0\,,
 \end{equation}
%
where $z_s$ is the source position on the principal axis. The evaluation of the
integral as it appears is impractical, thus some simplifications are required.

The Green's function $G$ can be expanded as a bilinear summation of orthonormal
functions ($u_ n$), the \textit{normal modes}~\cite{baker2003green}, weighted by
using their respective eigenvalues ($k_n$), the natural frequencies. The real
integral of (\ref{eq:normalmono}) can be evaluated through \textit{contour
integration} to exploit the residue of the poles present on the natural
frequencies. But this requires choosing a Riemann
sheet for the integral and evaluate the branch line integral
separately~\cite{jensen2011computational,worzel1948propagation}:

\begin{equation}
\psi = \oint \sum_n{\frac{u_n(z)\overline{u_n(z_s)}}{k^2 -
k_n^2}H_0^{(1)}(k_0r)k_0\dif k_0} + I_{\text{branch-cut}}\,.
\end{equation}

The branch line integral $I_{\text{branch-cut}}$ can be physically interpreted
%% SrJ: "continuous mode spectrum" ?
as the contribution of all other modes spectrum (those that are not
normal modes), representing modes that propagates through the ocean floor
(being strongly attenuated) and near-field, that decays exponentially with
distance. Assuming that the horizontal distance is several times the water
depth, the branch line term is ignored in most theoretical developments.

Therefore, by assuming a far-field approximation ($k_0r \ll 1$), besides
disregard the branch line integral, it is possible to consider an asymptotic expansion for the
Hankel function and evaluate the contour integral, obtaining~\cite{Etter2013}:

\begin{equation}
\label{eq:normalsolution}
\psi =
g(r)\sum_n{\frac{u_n(z)\overline{u_n(z_s)}}{\sqrt{k_n}}\mathrm{e}^{i(k_nr-\tfrac{\pi}{4})-\delta_nr}}\,.
\end{equation}

Here, $g(r)$ is a general function of the range and $\delta_n$ the attenuation
coefficient. In practice, the summation ranges over only a bounded number of
modes, but this number increases with frequency, which leaves it as undesirable
for high-frequency waves. 

One of the advantages of normal modes over ray theory lies on the fact that, for
each source/receiver position, the ray approach have to run a full simulation of
the rays, while the normal modes have a closed form (like (\ref{eq:normalsolution})) that easily adapts to new combinations of these
parameters. In contrast, normal modes are constrained by the source frequency,
in fact by the number of modes to be computed, and generally requires deeper
knowledge of the environment. The attenuation
coefficient ($\delta_n$) in the ocean, for example, depends on water absorption,
ocean sediment layer absorptions, compressional and shear attenuation on the
basement, measures of the modes interactions with both sediment and
basement (compressional and shear mechanisms) and statistics on the
water-sediment boundary and sea surface as well.

\subsubsection{Parabolic approximation}

The parabolic approximation replaces the Helmholtz equation (\ref{eq:helmholtz}),
which is an elliptic partial differential equation, by a simplified parabolic
%% SrJ?: give me your time travelling machine ...
version. This approximation dates back to the middle of the $\mathrm{XXI}$
century, in the context of tropospheric radio wave propagation.

The normal mode solution do not handle well non-stratified mediums. To overcome
this limitation parabolic approximation is constructed to handle slow varying
mediums. The variation is made explicit by $k = k_0n(r,z)$, where $n(r,z)$ is a
sound refractive index~\cite{LURTON}. The Helmholtz equation becomes:

\begin{equation}
\label{eq:varyhelmholtz}
(\nabla^2 - k_0^2n^2(r,z))\psi = 0\,.
\end{equation}

The solutions are assumed to have a fast varying horizontal field
$H_0^{(1)}(k_0r)$ and overall slow fluctuations $F(r,z)$:

\begin{equation*}
\psi(r,z) = F(r,z)H_0^{(1)}(k_0r)\,.
\end{equation*}

Assuming asymptotic behavior to the Hankel function (similar to normal modes
development) and applying it to (\ref{eq:varyhelmholtz}):

\begin{equation}
\label{eq:preparabolic}
\fdifn{r}{2}F + 2ik_0\fdif{r}F + \fdifn{z}{2}F + k_0^2(n^2-1)F = 0\,.
\end{equation}

By the assumption that $F(r,z)$ is a slow varying field, the $\fdifn{r}{2}F$
term is neglected and (\ref{eq:preparabolic}) gives rise to the parabolic
equation.~\citet{LURTON} proceeds further by discretizing the horizontal
directions, without defining explicit dependence on the Hankel function, and
using an approximation for the differentials on $z$ through pseudo-differential
operator.

The parabolic equation can then be solved numerically, but the grid size vary
with frequency, becoming costly for high-frequency waves. For more
details, see~\citet{jensen2011computational}.

\subsection{Ray Theory}
\label{ss:raytheory}

Ray Theory provides a good way to treat high-frequency sound propagation,
far from caustics, that retain an intuitive meaning. Introduced in Subsection
\ref{ss:simuloverview}, it is very similar to its electromagnetic counterpart.
Each ray carries an energy density from the source that decays as it travels
through the medium (Transmission loss). When it encounters an obstacle (e.g. sea floor, sea
surface, man made surfaces), it (back)scatter to the source
(\ref{eq:preeikonalamp}). That is the
classical (non-multipath) description
~\cite{LURTON,Etter2013,miller2015real,bell1997application}, summarized by a
sonar equation as:

\begin{equation}
\label{eq:sonareq}
\text{RL} = \text{SL} - \text{DI} - \text{TL} + \text{TS}
\end{equation}

Each of these acronyms corresponds to energy (intensity), or energy variation,
written in decibels (\ref{eq:dB}):
\begin{enumerate}
  \item RL is the Received Level - $10\log_{10}([\text{Received
  intensity}]/[\text{reference intensity\footnotemark}])$
  \footnotetext{Intensity of plane wave with pressure amplitude of 1 $\mu$Pa.}
  \item SL is the Source Level - $10\log_{10}([\text{Intensity at
  1m\footnotemark}]/[\text{reference
  intensity}])$
  \footnotetext{for an equivalent omnidirectional source.}
  \item DI is the Directivity Index - $10\log_{10}([\text{Directional
  loss\footnotemark}])$
  \footnotetext{with respect to an omnidirectional source.}
  \item TL is the Transmission loss - Intensity loss through absorption and
  spreading while propagating (in dB).
  %% SrJ: I don't get the difference between TS and RL
  \item TS is the Target Strength - ratio between the intensity of outgoing
  and incoming rays on a target hit (in dB).
\end{enumerate}



Equation (\ref{eq:sonareq}) does not fully describes how the simulation
using ray theory should work, but gives a good insight on the elements that must
be considered. SL can be inferred by the sonar power and efficiency, DI comes
from the sonar beam pattern, TL is dependent on the medium, but is compensated
by the sonar TVG (see Subsection \ref{sss:tvg}) and TS is defined by a material
dependent BRDF\abbrev{BRDF}{Bidirectional Reflectance
Distribution Function} (Bidirectional Reflectance
Distribution Function), described further ahead.

\subsubsection{Ray Interaction}

For a more faithful sonar response, advanced simulation techniques based on ray
theory can be applied. And, thus, requires careful consideration on the most
important interactions of the rays with the interfaces, namely:
\textbf{transmitted rays}, \textbf{reflected rays}  and \textbf{scattered rays},
see Figure \ref{fig:brdfbtdf}.

\subsubsection{Transmitted Rays}
When a radiant energy, in this setup represented by a ray, hits a point on a
surface (or a general interface) part of the energy is absorbed, part is
transmitted and, yet, another part bounces back Transmitted rays represent the
energy that goes through the interface, their intensity for each direction is
%% BDTF -> "Transmitted Scatter" ?
mathematically defined by the BTDF\abbrev{BTDF}{Transmitted Scatter Distribution
Function} (Transmitted Scatter Distribution
Function)~\cite{bartell1981theory} (see~\citet{rober2007ray} for an acoustic
approach).


\begin{figure}[h]
	\centering
	\input{Chap2/fig/ray_reflect}
	\caption{Incident and reflected rays with respective angles.}
	\label{fig:ray_reflect}
\end{figure}


\subsubsection{Scattered and Reflected rays}
\label{sss:rays}
The treatment for reflected and scattered rays starts together by means of the
BRDF (Bidirectional Reflectance Distribution
Function)~\cite{blake1995remote,miller2015real,durany2015analytical}, which works
similar to BTDF. On perfect smooth surfaces, its BRDF exhibits a single
direction, the specular reflection, where the ray intensity is non-zero at the
same plane of incident ray and the same angle with the surface normal vector.
This kind of reflection is responsible for mirror like effects, e.g. sound that hits
the still water surface from within~\cite{LURTON,Etter2013}.

The other extreme case is the perfect diffuse reflection (usually called scatter
in acoustics), where a rough surface reflects same perceived energy (radiance)
in all directions, thus following a cosine law (Lambert's Cosine Law) with
respect to the incident and reflected(scattered) angles
~\cite{united1977geometrical,cox2004acoustic}:

\begin{equation}
\label{eq:lambertian}
I_r \propto	 I_i \cos(\theta_i) \cos(\theta_r)\,,
\end{equation}
%
where $I_i$,  $I_r$ and $\theta_i$, $\theta_r$ are the intensity and angle with
the surface normal for the incident and reflected rays,
respectively (Figure \ref{fig:ray_reflect}). The proportionality constant is
material dependent and should not exceed $\nicefrac{1}{\pi}$, because that would violate
energy conservation.

If incoming and reflected rays have the same direction, the angle is the same
and the situation is called a \textit{backscatter}:

\begin{equation*}
I_r \propto I_i \cos^2(\theta_i)\,.
\end{equation*}

There is some confusion in the literature about the cosine being or not
squared~\cite{durany2015analytical,cox2006tutorial,cox2004acoustic,jones2009modelling,LURTON,Etter2013}.
Possible explanations are mixing intensity information with pressure
or related quantities, as intensity and radiance. This cosine law, for a single
scatter, describes the Target Strength, in $\text{dB}$:

\begin{equation*}
\text{TS} = A + 20\log_{10}(\cos(\theta_i))\,.
\end{equation*}

Here, $A$ is the equivalent of the proportionality constant. Under the
assumption of no energy loss through transmission or absorption,
$A=-10\log_{10}(\pi)\text{dB} \approx -5\text{dB}$. More realistic values vary
from $-17\text{dB}$ for basalt ridge cliffs to $-27\text{dB}$ for sediment
pond~\cite{dunn2015springer}.
Transmission and reflection between multiple sediment layers at the bottom of
the ocean can be treated as a single entity, subbottom scattering, that introduces a
delay and a displacement of the reflection~\cite{Etter2013}, that case will not
be covered by the simulation procedure proposed in this thesis. A remarkable
property of the scattered rays is the incoherence which makes possible to add
the energy (intensity) contributions for each ray directly, according to
equation (\ref{eq:intensity_sum}).

Rough ocean surface, in the presence of wind, also backscatters, but not as a
perfect scatter. Its scattering properties have been modeled in a variety of
ways~\cite{jones2009modelling}, like Kirchhoff model~\cite{dunn2015springer}:

\begin{equation*}
\text{TS} = -10~\Gamma^2\log_{10}(e) \approx -4.34~\Gamma^2\,,
\end{equation*}
%
where $\Gamma = 2kh\cos(\theta_i)$, $k$ is the acoustic wavenumber
(\ref{eq:helmholtz}), $h$ is the r.m.s. height of the surface.

A general surface does not follow neither a perfect cosine law nor is a perfect
reflector, but is useful to model as a compromise of
both~\cite{cox2006tutorial,vorlander2000definition}, even some standards for
acoustic measurement (e.g. ISO\abbrev{ISO}{International Organization for
Standardization}) split between these two types of reflection~\cite{rindel2001scattering}. An absorption/transmission factor
$\alpha$ defines the fraction of the energy that does not reflect back, and a scattering
factor $\delta$ the fraction of the reflected energy that is scattered (figure
\ref{fig:scatter}).

\begin{figure}[h]
	\centering
	\input{Chap2/fig/scatter}
	\caption{Scattering reflection weighted.}
	\label{fig:scatter}
\end{figure}

This weighting concept is explored to create a full BRDF function as
$\rho(\vec{i},\vec{r}) = (1-\alpha)(\delta \rho_\text{scat}(\vec{i},\vec{r}) +
(1-\delta) \rho_\text{spec}(\vec{i},\vec{r}) )$. For a numerical treatment, one
option is to discretize the solid angles as~\citet{siltanen2007room} describes;
another is to model as computer graphics, where, instead of a single direction
for the specular reflection, the specular reflection is a smooth function of the
reflected direction with a peak at the actual specular direction. This smooth
function creates a better transition from specular to scatter reflection. A
standard model is Phong reflection~\cite{phong1975illumination}:

\begin{equation}
\label{eq:phong}
I_r \propto	 I_i \cos(\theta_s)^\nu\,.
\end{equation} 

Here, $\theta_s$ is the angle between the reflected direction and the specular
direction. And $\nu$ a shininess constant describing how concetrated the
specular reflection is. In the limit of $\nu \to \infty$ it becomes a perfect mirror.


\begin{figure}
	\centering
	\includegraphics[width=0.8\textwidth]{Chap2/fig/BRDF_BTDF}
	\caption{BRDF and BTDF for transmitted, reflected and scattered rays.
	(\textcopyright  \href{http://commons.wikimedia.org/wiki/User:Jurohi}{User:Jurohi} /
	\href{http://commons.wikimedia.org/}{Wikimedia Commons} /
	\href{http://creativecommons.org/licenses/by-sa/3.0/}{CC-BY-SA-3.0})}
	\label{fig:brdfbtdf}
\end{figure}




\subsubsection{Ray Tracing}

Ray Tracing was originally an algorithm that used ray theory
(described earlier in Section \ref{sss:raytheory}) for computer graphics with a
rationale very similar to the sonar equation (\ref{eq:sonareq}). It traced a ray to every point on the scene
from the source and the receiver, then computed the intensity of each color,
ignoring multiple reflections. 

A variety of derivations from the original algorithm have being concieved. Most
of the methods applied to audio were developed for computer graphics
%% SrJ: "rederization" ? Is that "rendering" ?
rendering, but, considering sound waves with similar constrains to those
applied to light (i.e. high frequency limit), it is reasonable to apply them to
aurelization (sound renderization) as well.


Among the most common techniques are \textbf{Image Source}, \textbf{Beam
Tracing}, \textbf{Metropolis Transport} and \textbf{Path Tracing}. Their
standard implementation assume homogeneous medium, effectively propagating rays
as straight lines. An important alternative, which also overcomes sharp shadows
and caustics issues, is \textit{Gaussian Beam}, that evaluates the acoustic
field at every point by adding contributions of each ray. The name comes from the fact
that weight of a ray decays in the paraxial direction as a gaussian. It is
typically computationally more costly than other ray tracing, but have
applications for inhomogeneous open environments as described by
~\citet{traceroutdoor}.

\subsubsection{Image Source}

This method focus on environments composed by segments on the 2D case or
polygonal slices of planes on the 3D case. It works best on box like
environments, for this creates a perfect tiling of
space~\cite{funkhouser2003survey} (see Figure \ref{fig:tillingsource}).

For each reflective surface, a virtual source is created on the reflected
position of the source, these are the primary virtual sources. A virtual source
will act just like a source, although its intensity is lessened by the absorption
factor of the wall. When computing the sound at point, the
contribution of each source (including virtual ones) are added together, the
reflections are automatically taken into account by the virtual sources.

\begin{figure}[h]
	\centering
	\input{Chap2/fig/imagesource}
	\caption{The source E and the virtual sources E',E'$_1$,E'$_2$,E'$_3$. In this
	case, E'$_3$ is not a visible virtual source.}
	\label{fig:imagesource}
\end{figure}


The procedure of creating the virtual sources may be repeated many times for
each new virtual sources, thus more reflection are effectively calculated. The
visibility of a virtual source must be validated before adding its contribution.

\begin{figure}[h]
	\centering
	\input{Chap2/fig/planetilling_source}
	\caption{Source on a perfect tilling. The simple pattern facilitates
	computation.}
	\label{fig:tillingsource}
\end{figure}

The method does not direct implement the ideia of sound scattering, but there
are some possible extensions~\cite{chandak2011fast}. In practice, for more
complex environments, only a few early reflection are generated. The number
$O(n^r)$ of sources, where $n$ is the number of surface planes and $r$ the
number of reflections, that must be created and validated grows exponentially
fast.

\subsubsection{Beam Tracing}

Beam Trancing uses pyramidals beams, a collection of rays, instead of single
infinitesimal rays to calculate reflections~\cite{funkhouser2003survey}. The
solid angle on the source that describes available sound directions can be
subdivided in pyramidal beams without overlap, avoiding sampling issues. These
pyramidal beams exploit the spacial relation between nearby rays, being able to
consider the propagation path without skipping any ray.

\begin{figure}[h]
	\centering
	\input{Chap2/fig/beamtracing}
	\caption{A 2D view of a pyramidal beam tracing.}
	\label{fig:beamtrace}
\end{figure}

The algorithm starts by subdividing the sounce sound directions into pyramidal
regions. For each pyramidal beam, intersections with environment walls are
calculated from the first encounter to the last, clipping the beam so no
shadowed regions are considered. The resulting polygons of each intersection act
as a new virtual source, constructed by mirroring the source as in the Image
Source method. Beam Tracing, then, progresses by repeating this procedure on
each virtual source, until the desired precision (number of reflections) is
achieved.

It does no suffer from visibility computation issued as Image Source, but is
less efficient for highly structured box-like environments. Despite working well
on simple scenes (with or without occlusions), it still not handling well
curved surfaces.


\subsubsection{Path Tracing}

Path Tracing is a recursive solution to the wave equation simplification used in
ray theory. That can be written, in terms of the radiance $\ell$ (the ray
energy - acoustic energy per unit of surface area per unit of solid angle), as an
integral equation, the \textit{room acoustics rendering
equation}~\cite{siltanen2007room}:

\begin{equation}
\label{eq:roomacoustics}
\ell (\coord{p},\Omega) = \ell_0(\coord{p},\Omega) + \int_\mathcal{G}
R(\coord{x},\coord{p},\Omega) \ell
(\coord{x},\overrightarrow{\coord{x}\coord{p}} ) \dif\mu(\coord{x})\,,
\end{equation}
%
where $\mathcal{G}$ is the two dimensional subset of $\mathbb{R}^3$ comprising
all surfaces, $\coord{p}$ is a point over a surface, $\dif\mu(\coord{x})$ is the
surface area differential at point $\coord{x}$, $\Omega$ is the outgoing
%% SrJ: I don't understand the "source point" comment ... It's surface radiance
%% SrJ: ... so I would write e.g. "in case the surface is an emitter", no?
energy direction, $\ell_0$ the intrinsic surface radiance (in case the surface is an emitter), $\overrightarrow{\coord{x}\coord{p}}$ the unit vector in the direction to $\coord{p}$ from point $\coord{x}$. The function $R(\parm,\parm,\parm)$ is the
\textit{reflection kernel}, an enhanced version of a BDRF. For a non-obstructed path between 
$\coord{p}$ and $\coord{x}$:

\begin{equation}
\label{eq:reflectionkernel}
R(\coord{x},\coord{p},\Omega) =
\mathfrak{a}(\norm{\coord{p}-\coord{x}})\rho_\coord{p}(\overrightarrow{\coord{x}\coord{p}},\Omega)\cos(\theta_i)\cos(\theta_r)\,.
\end{equation}

When there is no visibility from  $\coord{x}$ to $\coord{p}$,
$R(\coord{p},\coord{x},\Omega) = 0$. Here,
$\rho_\coord{p}(\overrightarrow{\coord{x}\coord{p}},\Omega)$ is the BDRF at the
point $\coord{p}$ with incoming direction $\overrightarrow{\coord{x}\coord{p}}$
%% SrJ?: omega is not a direction, but the incoming energy, or ?
and outgoing energy direction $\Omega$, $\theta_i$ and $\theta_r$ are the
incoming and reflected angles with surface's normal at point $\coord{p}$ for directions $\overrightarrow{\coord{x}\coord{p}}$
and $\Omega$, respectively. Factor $\mathfrak{a}(\norm{\coord{p}-\coord{x}})$ is
the decay dependent on the distance $\norm{\coord{p}-\coord{x}}$ caused
by spreading and absoption, usually an inverse squared times an exponential
factor (commented in Subsection \ref{sss:tvg}).

The solution to equation (\ref{eq:roomacoustics}) is a Neumann series:



\begin{subequations}

\begin{equation}
\label{eq:neumannincrement}
\ell_{n+1} (\coord{p},\Omega) = \int_\mathcal{G}
R(\coord{x},\coord{p},\Omega) \ell_n
(\coord{x},\overrightarrow{\coord{x}\coord{p}} ) \dif\mu(\coord{x})\,,
\end{equation}

\begin{equation}
\label{eq:neumannsummation}
\ell (\coord{p},\Omega) = \sum_{n=0}^\infty \ell_n (\coord{p},\Omega) \,.
\end{equation}
\end{subequations}

For the actual computation, the summation on equation (\ref{eq:neumannsummation})
is truncated at some reasonable value of $n$, which is the number of
reflections being considered, and the integral on equation
(\ref{eq:neumannincrement}) can be approximated using, for example, a Monte Carlo
method applying importance sampling w.r.t. the function $R(\parm,\parm,\parm)$
(~\citet{munjal2013formulas} describe briefly such an algorithm).
When scattering is not strong enough, it is a common practice to consider only
specular directions. 

Besides the success of computer graphics using the same technique, in the end of
the last century there were still some concerns regarding the theoretical
validity, manly because it was shown to be
uncomputable~\cite{reif1994computability}. That is, it was impossible to say if
a ray would ever reach a certain point. Later, this decade, it was shown by
~\citet{blakey2014ray} that, if one considers computational finite precision, it
can be proven to be computable.

In the case of sonar, the only important point to measure the sound intensity is
on the sonar itself. A simplified approach for the integral on equation
(\ref{eq:neumannincrement}) is to consider only the specular direction (where it
is supposed to have greater radiance) and the scattered direction into the
sonar, assuming the other scattered directions will die out without much
affecting the sonar response.


\subsubsection{Metropolis Transport}

Metropolis Light Transport (MLT\abbrev{MLT}{Metropolis Light Transport}) is an
incremental development over Path Tracing.
It records the path taken by a ray as a tree where each reflection point is a node. By
adding, removing or changing nodes, it is able to better explore the space
without ruling out the work done to produce a path from source to detector.

The name comes from the use of Metropolis sampling method to explore the space,
which degenerate paths that are small variations of the original one. A change
in the path may be accepted or rejected (as in the original Metropolis method)
and the decision strategy ensures an ergotic, unbiased and generally applicable
result.

At the cost of added complexity, MLT gives better results specially around
caustics and difficult to reach regions (e.g. through a narrow aperture)
without degrading performance. The original paper by~\citet{veach1997metropolis}
explains with great clarity the math behind as well as the results and
interpretations.


% 
% 
% rough water surface scattering -~\citet{jones2009modelling}d
% 
% Many materials follow Lambert's law closely in scat-
% tering light and it is also a good approximation for
% backscattering of sound by rough -~\citet{blake1995remote}d
% 
% Ray Trace Lambert (cosseno duplo) -~\citet{cox2004acoustic}d
% 
% Deep BRDF compare with Lambert -~\citet{miller2015real}d
% 
% Analytical BRDF -~\citet{durany2015analytical}d
% 
% Monte Carlo -~\citet{munjal2013formulas}d
% 
% Image source, scattering ray theory -~\citet{chandak2011fast} d
% 
% Image source, Beam tracing -~\citet{funkhouser2003survey}d
% 
% Split scattering/reflection measurement -~\citet{vorlander2000definition}d
% 
% Local acoustic Energy Exchange (but no Lambert) -~\citet{rober2007ray}d
% 
% The room acoustic rendering equation (most of all)-~\citet{siltanen2007room}d
% 
% Backscattering single consideration -~\citet{LURTON,Etter2013}d
% 
% ISO and AES scattering measuring -~\citet{rindel2001scattering}d
% 
% Scattering coefficients (+ too deep) -~\citet{cox2006tutorial}d
% 
% Workflow simulation -~\citet{bell1997simulation}
