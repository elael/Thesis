\chapter{\label{chap::sing}Singularidades e métodos alternativos}

A solução de (\ref{eq::regra}) pode ser computada  somente  quando a matriz Jacobiana possui posto completo. Entretanto, ela pode tornar-se sem sentido quando o manipulador está em  uma  {\it configuração singular} e neste caso o sistema  de  controle  (\ref{eq:sys}) possui equações linearmente dependentes. É importante ressaltar que a inversão da matriz Jacobiana pode representar um grande incoveniente não apenas em uma configuração singular mas  também  na  vizinhança  de  uma  singularidade, onde a matriz se torna mal condicionada, apresentando pivôs muito pequenos e resultando em grandes valores de velocidades das juntas. Neste capítulo é apresentada uma análise de configurações singulares para manipuladores antropomórficos, cinematicamente simples e bastante empregados por tal facilidade. Serão apresentados também dois algoritmos gerais para solucionar o problema de cinemática inversa na presença de singularidades. O algoritmo DLS utiliza um fator de amortecimento para tornar a inversão melhor condicionada, estabelecendo um compromisso entre a viabilidade e a exatidão da solução, \cite{NH:86} e \cite{W:86}. O algoritmo FIK, por sua vez, apresenta uma proposta alternativa que não exige inversão matricial, solucionando o problema sob o ponto de vista de controle ao empregar um laço de realimentação para minimizar a discrepância entre as velocidades demandada e atual, \cite{P:08}.

\section{SVD e Manipulabilidade}

Uma análise mais rigorosa do comportamento da solução para a cinemática inversa na vizinhança  de  uma configuração  singular  pode  ser  desenvolvida recorrendo-se  à {\it decomposição  em  valores  singulares} da matriz Jacobiana \cite{MK:89}. Assim, seja
%
\begin{equation}
\label{eq::svdexp}
{\bf J} = \sum_{i = 1}^{m}\sigma_i {\bf u}_i {\bf v}_i^T 
\end{equation}
%
onde ${\bf v}_i$ e ${\bf u}_i$ são os vetores singulares de entrada e saída, respectivamente, e $\sigma_i$ são os valores singulares ordenados tal que 
$\sigma_1 \geq \sigma_2 \geq ... \sigma_r > 0$, sendo $r$ o posto de ${\bf J}$ 
\footnote{A equação (\ref{eq::svdexp}) apresenta a decomposição SVD de uma forma compacta e específica para manipuladores robóticos, onde $m \leq n$. Na forma geral, a decomposição SVD de uma matriz ${\bf A}$ pode ser expressa por ${\bf A} = {\bf U} {\boldsymbol \Sigma} {\bf V}^T$, incluindo os vetores ${\bf v}_i$ (últimas $n - r$ colunas de ${\bf V}$) e ${\bf u}_i$ (últimas $m - r$ colunas de ${\bf U}$) que fornecem bases ortonormais para os espaços nulo e nulo à esquerda de ${\bf A}$, respectivamente \cite{STRANG}.}. Quando ${\bf J}$ multiplica uma coluna ${\bf v}_j$, produz $\sigma_j$ vezes a coluna ${\bf u}_j$, isto é,
%
\begin{equation}
\label{eq::mobility}
{\bf J}\,{\bf v}_j = \sigma_j {\bf u}_j, 
\end{equation}
%
o que permite uma análise da mobilidade da estrutura mecânica na direção ${\bf u}_j$ através de $\sigma_j$. 
%A Figura \ref{fig::mapping} apresenta um exemplo $m=n=2$ para este mapeamento.
%
%\begin{figure}[htpb]
%  \centering
%  \def\JPicScale{0.95}
%  {\small
%  \input{fig/mapping.pst}
%  }
%  \caption{Mapeamento ${\bf J}$ (análise SVD)}
%  \label{fig::mapping}
%\end{figure}
%
Para $\sigma_j >> 0$, movimentos na direção ${\bf u}_j$ podem ser obtidos com pequenas variáveis de entrada na direção ${\bf v}_j$. Por outro lado, para valores $\sigma_j$ pequenos, movimentos nesta direção ainda são possíveis mas exigem grandes variáveis de entrada. Neste caso, a mobilidade da estrutura mecânica é reduzida e grandes velocidades devem existir no espaço de velocidades das juntas para que pequenas velocidades no espaço de operação sejam alcançadas. No caso limite, em que $\sigma_j = 0$, movimentos na direção ${\bf u}_j$ tornam-se não-factíveis e configura-se uma singularidade cinemática. 

A decomposição SVD permite caracterizar a manipulabilidade da 
estrutura 
em termos de velocidade. Considere o conjunto de velocidades de norma unitária e constante
%
\begin{equation}
\label{eq::ellnormaq}
\dot{\bf q}^T \dot{\bf q} = 1	.
\end{equation}
%
Esta igualdade descreve os pontos de uma esfera no espaço de velocidades das juntas. Para descrever as velocidades no espaço operacional que podem ser desenvolvidas  por este conjunto de velocidades de juntas, utiliza-se a equação de cinemática diferencial. Para o caso geral de manipuladores redundantes, a solução de norma mínima $\dot{\bf q} = {\bf J}^{\dagger}{\boldsymbol \nu}$ pode ser considerada e ao substituir em (\ref{eq::ellnormaq}) obtem-se
%
%\begin{equation}
%\label{eq::ellnormav}
%{\boldsymbol \nu^T}({{\bf J}({\bf q})^{\dagger}}^T{\bf J}({\bf q})^{\dagger}){\boldsymbol \nu} = 1,
%\end{equation}
%
%Considerando a expressão para ${\bf J}^{\dagger}$ em (\ref{eq::ellnormav})
%
\begin{equation}
\label{eq::ellnormav2}
{\boldsymbol \nu^T}({\bf J}({\bf q}){\bf J}({\bf q})^T)^{-1}{\boldsymbol \nu} = 1,
\end{equation}
%
que define um elipsóide no espaço de velocidades do efetuador \cite{SSVO:09}. A forma e a orientação do elipsóide são determinadas pelo núcleo da forma quadrática e portanto pela matrix ${\bf JJ}^T$. A direção dos eixos principais são definidas pelos vetores ${\bf u}_i$, para $i = 1,2,..., r$ e as dimensões do eixos são dadas pelos valores singulares de ${\bf J}$ \cite{STRANG}. Uma medida bastante utilizada para a manipulabilidade é o volume do elipsóide definido em (\ref{eq::ellnormav2}), proporcional a
%
\begin{equation}
\omega({\bf q}) = \sqrt{\det{\bf J}({\bf q}){\bf J}^{T}({\bf q})}.
\end{equation}
% 
A Figura \ref{fig::ellips} apresenta elipsóides de manipulabilidade para uma braço planar 2R (2 juntas de revolução) em diferentes posturas.

\begin{figure}[htpb]
  \centering
  \def\JPicScale{0.37}
  {\small
  \input{fig/planell.pst}
  }
  \caption{Elipsóides de manipulabilidade de velocidade para robô planar}
  \label{fig::ellips}
\end{figure}

\section{Singularidades em Robôs Antropomórficos}

A maioria dos manipuladores existentes são cinematicamente simples, uma vez que eles são tipicamente constituídos por um braço e um punho esférico. Esta escolha é parcialmente motivada pela dificuldade de encontrar soluções para o problema de cinemática inversa no caso geral. Felizmente, a estrutura de um manipulador antropomórfico permite articular o problema de cinemática inversa em dois subproblemas, uma vez que a solução para a posição do punho é desacoplada da orientação \cite{SSVO:09}. Neste contexto, manipuladores antropomórficos constituem uma classe de manipuladores de particular interesse para o trabalho desenvolvido. A estrutura mecânica desta classe de manipuladores é introduzida na Figura \ref{antropomorfico}, recebendo este nome devido à sua similaridade com um braço humano.

%\begin{figure}[!htb]
%\centering
%\includegraphics[scale=0.22]{fig/antropomorficoeps.eps}
%\caption{Manipulador antropomórfico com punho esférico}
%\label{antropomorfico}
%\end{figure}
%
\begin{figure}[htpb]
  \centering
  \def\JPicScale{0.55} %58
  {\small
  \input{fig/antropomorgico.pst}
  }
  \caption{Manipulador antropomórfico com punho esférico}
  \label{antropomorfico}
\end{figure}

Um {\it manipulador antropomórfico com punho esférico} é composto por seis juntas de revolução, cada uma adicionando um grau de liberdade ao movimento da estrutura mecânica. Uma característica física importante neste tipo de manipulador é o desacoplamento da posição do punho e da orientação.
%, como pode ser visto na Figura \ref{antropomorfico}.
%Nota-se que a escolha da origem do sistema de coordenadas do efetuador no punho implicaria no desacoplamento da posição deste, o que simplifica o problema. Porém, a escolha conveniente e natural para a origem deste sistema de coordenadas é na extremidade do efetuador, onde geralmente ocorre o contato com superfícies ou objetos no espaço de trabalho. 
\newpage
Sejam ${\bf p}_w$ e ${\bf R}_{0e}$ a posição do punho e a orientação do efetuador com respeito ao sistema de coordenadas da base, respectivamente (neste caso, o sistema de coordenadas da base é coincidente com o sistema de coordenadas 0), dadas por 
%
\begin{eqnarray}
\label{antro1}
{\bf p}_w &=& f_1(q_1,q_2,q_3)\\
\label{antro2}
{\bf R}_{0e} &=& f_2(q_1,q_2,q_3,q_4,q_5,q_6),
\end{eqnarray}
%
onde $f_1 : {\mathbb R}^3 \rightarrow {\mathbb R}^3$ e $f_2 : {\mathbb R}^6 \rightarrow {\mathbb R}^{3\times3}$. A relação entre a velocidade linear ${\bf p}_w$ e a velocidade angular ${\boldsymbol \omega}_e$ com as velocidades das variáveis de juntas é dada por
%
\begin{equation}
\label{desacoplamento}
\left[\begin{matrix}
							\dot{\bf p}_w \\
							{\boldsymbol \omega}_e\\
							\end{matrix}\right]
							= \left[\begin{matrix}
							{\bf J}_{11} & {\bf 0}_{3\times3}\\
							{\bf J}_{21} & {\bf J}_{22}\\
							\end{matrix}\right]
							\left[\begin{matrix}
							\dot{\bf q}_p	\\
							\dot{\bf q}_o	\\
							\end{matrix}\right],
\end{equation}
%
onde ${\bf q}_p \in {\mathbb R}^3$ corresponde ao vetor de velocidades das três primeiras juntas e ${\bf q}_o \in {\mathbb R}^3$ corresponde ao vetor de velocidades das três últimas juntas, ou juntas do punho. Nota-se a partir de (\ref{desacoplamento}) que o {\it Jacobiano Geométrico} assume uma forma bloco triangular, em que a posição do punho depende apenas das velocidades das três primeiras juntas. Tendo em vista a equação (\ref{desacoplamento}), o Jacobiano é triangular por blocos e seu determinante pode então ser calculado a partir dos determinantes de cada bloco. Assim,
%
\begin{equation}
\det({\bf J}_G) = \det({\bf J}_{11})\,\det({\bf J}_{22}). 
\end{equation}
%
%Para manipulador antropomórficos com punho esférico, é possível dividir o cálculo das singularidades em dois problemas:
%
%\begin{itemize}%
%	\item singularidade do braço - resultante do movimento dos 3 primeiros elos; 
%	\item singularidade de punho - resultante do movimento das juntas do punho.
%\end{itemize}
%
A igualdade $\det({\bf J}_{11}) = 0$ corresponderá a uma singularidade de braço (singularidade de ombro e de cotovelo), resultante do movimento dos 3 primeiros elos, e $\det({\bf J}_{22}) = 0$ a uma singularidade de punho. Deve-se notar que o Jacobiano considerado não fornece a relação entre as velocidades das juntas e as velocidades do efetuador, e sim do punho. Porém, permite o cálculo simplificado das configurações singulares. Na Figura \ref{fig:singantro} são apresentados ambos os tipos de singularidades existentes para o manipulador em questão. Note a existência de infinitas soluções para a cinemática inversa em singularidades de ombro e punho (Figuras \ref{fig:singantro}.b e \ref{fig:singantro}.c, respectivamente).
%\begin{figure}[!htb]
%\centering
%\includegraphics[scale=0.16]{fig/singularidadeseps.eps}
%\caption{Configurações singulares: cotovelo(i), ombro(ii) e punho (iii)}
%\label{fig::singantro}
%\end{figure}

\begin{figure}[htpb]
  \centering
  \def\JPicScale{0.32}
  {\tiny
  \input{fig/singularidades.pst}
  }
  \caption{Configurações singulares: (a)cotovelo, (b)ombro e (c)punho.}
  \label{fig:singantro}
\end{figure}

Como visto, as singularidades cinemáticas são configurações que se deseja evitar. Caso contrário, algoritmos alternativos devem ser empregados.

%\section{Algortimos alternativos}

%A solução de \ref{eq:u1} pode ser computada  somente  quando a
%matriz Jacobiana possui posto completo. Entretanto, ela pode tornar-se
%sem sentido quando o manipulador está em  uma  {\it       configuração
%singular} e neste caso o sistema  de  controle  \ref{eq:sys}   possui
%equações linearmente dependentes.
%
% Note que, é possível encontrar uma solução para $u$ extraindo todas as
% equações linearmente independentes se ${\bf v}\!\in\!{\mathcal R}(J)$.
% A ocorrência dessa situação significa que o caminho atribuído       ao
% manipulador é fisicamente realizável, mesmo  que  ele  esteja  em  uma
% configuração singular. Por outro lado,                              se
% ${\bf v}\!\notin\!{\mathcal R}(J)$, o  sistema de equações  não possui
% solução e isto significa que o  caminho do  espaço         operacional
% ${\mathcal O}$  não  pode  ser   realizado  pelo manipulador para  uma
% determinada postura \cite{SSVO:08}.
%%
%
%É importante ressaltar que a inversão da matriz Jacobiana pode representar um grande inconveniente não  apenas  em  uma   configuração
%singular mas  também  na  vizinhança  de  uma  singularidade. De fato,
%%sabe-se  que  o  cálculo  da  inversa  da  matriz  Jacobiana  requer a
%computação  do  seu  determinante,  e  que  na  vizinhança  de     uma
%singularidade este valor torna-se relativamente pequeno resultando  em
%grandes valores de velocidades das juntas.
%
%Neste contexto, uma análise mais rigorosa do comportamento  da solução
%%na vizinhança  de  uma configuração  singular  pode  ser  desenvolvida
%recorrendo-se  a {\it decomposição  em  valores  singulares} da matriz
%Jacobiana \cite{MK:89}.
%

%\newpage
%%%%%%%%%%%%%%%%%%%%%%%%% simulacao ZEBRA
\begin{simulation}
\label{sim::zebra} 
\end{simulation}

\noindent Considere o manipulador antropomórfico Zebra-ZERO (Apêndice \ref{ap::zebra}), e o rastreamento de posição do punho (\nameref{trajze0}) e regulação da orientação (${\bf R}_d = {\bf R}_y(\pi/2)$). A seguir, são apresentados resultados obtidos para ${\boldsymbol \Lambda}_p = {\boldsymbol \Lambda}_o = 5\,{\bf I}$.

\begin{figure}[!htp]
			\includegraphics[trim = 2.7cm 1.2cm 2.7cm 0.5cm, scale = 0.49]{sim/simzebra_data.eps}\\
			%\includegraphics[trim = 2.7cm 10cm 2.7cm 1cm, scale = 0.49]{sim/sim3_data2.eps}\\ %\tiny{\,(b)} \\
			%\includegraphics[trim = 2.7cm 0cm 2.7cm 10cm, scale = 0.49]{sim/sim3_data2.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::zebra}: (a) norma do erro; (b) condicionamento; (c) $\dot{\bf q}_p$ e (d) $\dot{\bf q}_o$.}
\label{fig::zebradata}
\end{figure}

Novamente, os erros de postura tendem exponencialmente para zero de acordo com os ganhos ${\boldsymbol \Lambda}_p$ e ${\boldsymbol \Lambda}_o$ (Figura \ref{fig::zebradata}.a). A partir da Figura \ref{fig::zebradata}.b, nota-se que para $t \approx 9s$ o manipulador atinge a vizinhança de uma singularidade, resultando em picos de velocidade no espaço das juntas (Figuras \ref{fig::zebradata}.c e \ref{fig::zebradata}.d).

\begin{figure}[!htp]
\begin{tabular}{ll}
			\includegraphics[trim = 0cm 0.4cm 0cm 1cm, clip=true, scale = 0.39]{sim/zebra1.eps}& %\tiny{\,(b)} \\
			\includegraphics[trim = 20cm 0.4cm 0cm 1cm, scale = 0.39]{sim/zebra3.eps}\\ %\tiny{\,(b)} \\				
			\includegraphics[trim = 2.7cm 9cm 2.7cm 8.6cm, clip=true, scale = 0.49]{sim/indice.eps}\\
\end{tabular}			
\caption{Simulação \ref{sim::zebra}: Manipulador Zebra-ZERO em diferentes posturas: (a) afastada ($t \approx 1s$) e (b) próxima de uma singularidade ($t \approx 9s$).}
\end{figure}

%\begin{figure}[!htp]
  %\centering
 % \label{fig::zebra3d}
%			\begin{tabular}{cc}
%				\includegraphics[trim = 0cm 0cm 0cm 17cm, scale = 0.39]{sim/zebra1.eps}& %\tiny{\,(b)} \\
%				\includegraphics[trim = 0cm 0cm 0cm 17cm, scale = 0.39]{sim/zebra3.eps}\\ %\tiny{\,(b)} \\
%				\end{tabular}
%\caption{Simulação \ref{sim::zebra}: Manipulador Zebra-ZERO em diferentes posturas: (a) afastada ($t \approx 1s$) e (b) próxima de uma singularidade ($t \approx 9s$).}
%\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Algoritmo DLS}

Uma solução para superar o problema da inversão da equação de  cinemática  diferencial  na  vizinhança  de  uma  singularidade  é fornecida pelo método DLS ({\it Damped Least-Squares}) \cite{NH:86}. Nesta proposta, a inversa ou pseudo-inversa da matriz Jacobiana é substituída por
\vfill
\begin{equation}
\label{eq::jast}
{\bf J}^{\ast} = {\bf J}^{T}({\bf J}{\bf J}^{T} + \delta\,{\bf I})^{-1}\,,\quad \mbox{$\delta \geq 0$}
\end{equation}
%_{m \times m}
\vskip 0.2cm
\noindent onde $\delta$ é  um  fator  de  amortecimento  que  torna a  inversão melhor condicionada de um ponto de vista numérico \cite{MMW:93}. A solução depende deste fator de amortecimento, que estabelece um compromisso entre a exatidão ($\delta \approx 0$) e a viabilidade da solução ($\delta >> 0$). Desta forma, a identificação de diferentes métodos de adaptação de $\delta$ constitui um tema de pesquisa bastante relevante, como em \cite{NH:86},\cite{W:86} e \cite{CSO:94}. O fator de amortecimento $\delta$ pode ser calculado como \cite{NH:86}:
%
\begin{equation}
\delta = \left \{\begin{array}{cc} 0 & \,,\quad \mbox{$\omega \geq \omega_{0}$} \\  \delta_{0} \left(1-\frac{\omega}{\omega_0}\right) & \,,\quad \mbox{$\omega < \omega_0$} \end{array} \right.
\end{equation}
%
onde $\omega\!=\!\sqrt{\det{\bf J}({\bf q}){\bf J}^{T}({\bf q})}$  é  a  medida de manipulabilidade do manipulador, $\delta_{0}$ é uma constante que estabelece um fator de escalamento nas configurações singulares  e $\omega_{0}$ é um parâmetro que define o limite da vizinhança de uma configuração singular, sendo escolhido de acordo com a
estrutura mecânica do manipulador. Uma forma alternativa, proposta em \cite{CSO:94}, utiliza $\delta^2$ ao invés de $\delta$. A principal ideia por trás do método é amortecer as velocidades das juntas não-factíveis na vizinhança de uma configuração singular, permitindo ao efetuador desviar da trajetória de referência desejada, estando o desvio na direção e magnitude do movimento \cite{SSVO:09}. Utilizando (\ref{eq::jast}), a solução para a cinemática inversa pode ser calculada como
%
\begin{equation}
\label{eq::dlslaw}
\dot{{\bf q}} = {\bf J}^T({\bf J}{\bf J}^T + \delta\,{\bf I})^{-1}{\boldsymbol \nu}
\end{equation}
%_{m \times m}
onde ${\boldsymbol \nu} = \dot{\bf x}_d + {\boldsymbol \Lambda} {\bf e}$. A solução (\ref{eq::dlslaw}) satistaz a seguinte condição:
%
\begin{equation}
\label{eq::conddls}
\begin{array}{rr}
_{\min}\\
^{\dot{\bf q}}\\
\end{array}\left\|
{\boldsymbol \nu} - {\bf J}({\bf q})\dot{\bf q}
\right\|^2
+
\delta	
\left\|
\dot{\bf q}
\right\|^2,
\end{equation}
%
estabelecendo uma ponderação entre as condições de mínimos quadrados e norma mínima, ou seja, considerando tanto a acurácia quanto a viabilidade da solução. %Desta forma, a escolha de valores adequados para o fator de amortecimento $\lambda$ se torna essencial. 
A escolha de valores $\delta$ pequenos %($\lambda \approx 0$) 
resulta em soluções precisas mas com baixa robustez na vizinhança de singularidades. Por outro lado, a escolha de valores $\delta$ elevados 
%($\lambda >> 0$) 
resulta em pouca precisão de rastreamento mesmo quando soluções factíveis e precisas são possíveis \cite{AP:09}. 
Considerando (\ref{eq::svdexp}), a solução (\ref{eq::dlslaw}) proposta pelo algoritmo DLS pode ser reescrita como 
%
\begin{equation}
\dot{\bf q} = \sum_{i = 1}^{m} \frac{\sigma_i}{\sigma_i^2 + \delta} {\bf v}_i {\bf u}_i^T {\boldsymbol \nu}.
\end{equation}
%
Nota-se que para componentes associados a $\sigma_i >> \sqrt{\delta}$, o fator de amortecimento tem pouca influência e $\sigma_i/(\sigma_i^2 + \delta) \approx {1}/{\sigma_i}$.
%
%\begin{equation}
%\frac{\sigma_i}{\sigma_i^2 + \lambda} \approx \frac{1}{\sigma_i}.
%\end{equation}
% 
Por outro lado, na vizinhança de uma singularidade, o menor valor singular $\sigma_r$ se aproxima de zero e o componente associado a este também tenderá a zero pelo fator $\sigma_r/\delta$,
%
%\begin{equation}
%\frac{\sigma_r}{\sigma_r^2 + \lambda} \approx \frac{\sigma_r}{\lambda} 
%\end{equation}
% 
reduzindo as velocidades de juntas que estão associadas às componentes de $\boldsymbol \nu$ na direção ${\bf v}_r$, em que a estrutura apresenta mobilidade reduzida. No caso limite em que $\sigma_i = 0$, tem-se que $\sigma_i/\delta = 0$ e não há atuação \cite{CSO:94}. 
%
%\begin{figure}[htpb]
 % \centering
%  \def\JPicScale{0.3} %0.37
%  {\small
%  \input{fig/planell.pst}
%  }
%  \caption{Elipsóides de manipulabilidade de velocidade para manipulador planar}
%  \label{fig::ellips}
%\end{figure}

\section{Algoritmo FIK}

A solução mais recente para tratar o problema de cinemática inversa na proximidade de configurações singulares é o algoritmo FIK ({\it Feedback Inverse Kinematics}), apresentado em \cite{P:08}. O método apresenta uma proposta alternativa que não exige inversão matricial e soluciona o problema ao empregar um laço de realimentação para minimizar a diferença entre as velocidades demandada e atual. 

A discrepância entre a velocidade atual $\dot{\bf x} \in {\mathbb R}^m$ e a velocidade demandada ${\boldsymbol \nu} \in {\mathbb R}^m$ pode ser representada pelo vetor de erro ${\bf e}_v \in {\mathbb R}^m$ dado por
%
\begin{equation}
\label{eq::fikerror}
{\bf e}_v = {\boldsymbol \nu} - {\bf J}({\bf q})\dot{{\bf q}}.
\end{equation} 
%
Considere o laço de realimentação mostrado na Figura \ref{fig::fikdiag}, onde ${\bf K}(s)\in {\mathbb R}^{n \times m}$ é uma função de transferência matricial completa.  Existe uma forma adaptativa para ${\bf K}(s)$ que reduz o erro em (\ref{eq::fikerror}) para um valor arbitrariamente pequeno, resultando na seguinte solução para o problema de cinemática inversa:
%  
%The error in (\ref{eq::fikerror}) can be minimized by constructing a feedback loop as shown in Fig. \ref{fig::fikdiag}. If ${\bf K}(s)\in {\mathbb R}^{n \times m}$ represents a full trasnfer function matrix that acts as a control law, then there exists and adaptive form of ${\bf K}(s)$ that minimizes this error to an arbitrary small value, leading to the following solution to the inverse kinematics problem:
%
\begin{equation}
\label{eq::fiklaw}
\dot{\bf q} = {\bf K}(s)({\bf J}{\bf K}(s) + {\bf I})^{-1}{\boldsymbol \nu}.
\end{equation} 
%

\begin{figure}[htpb]
  \centering
  \def\JPicScale{0.83}
  \def\Ev{${\bf e}_v$}
  {\small
  \input{fig/FIK.pst}
  }
  \caption{Diagrama de blocos FIK}
  \label{fig::fikdiag}
\end{figure}

A matriz ${\bf K}(s)$ ótima apresenta a seguinte forma adaptativa:
%The optimal ${\bf K}(s)$ has the following adaptive form:
%
\begin{equation}
\label{eq::fikK}
{\bf K}(s) = {\bf J}^T({\bf q}){\mathcal G}(s{\bf I} - {\mathcal A})^{-1}
\end{equation}
%
onde ${\mathcal G} \in {\mathbb R}^{m \times m}$ é uma matriz positiva definida simétrica e ${\mathcal A} \in {\mathbb R}^{m \times m}$ é uma matriz negativa definida diagonal. 
%
A forma ótima para ${\bf K}(s)$ é obtida a partir do seguinte problema de minimização:
%Initially all joint variables are fixed at some non-zero values ${\bf q}_0$. The corresponding Jacobian is then computed to serve as a time invariant, transfer matrix that maps joint velocites to Cartesian velocitiesm, i.e. ${\bf J}({\bf q}_0) = {\bf J}_0 = \text{constant}$. Then an optimal ${\mathcal H}_{\infty}$ control law can be designed to solve the following sensitivity minimization problem:
%
\begin{equation}
\label{eq::fikmin}
\begin{matrix}
\text{min} \\
{\bf K}(s) \\
\end{matrix}
\left\|
\left(
\begin{matrix}
 {\boldsymbol \omega}_1(s)({\bf J}_0{\bf K}(s)+{\bf I})^{-1} \\
 {\boldsymbol \omega}_2({\bf J}_0{\bf K}(s)+{\bf I})^{-1}
\end{matrix}
\right)
\right\|
\end{equation}
%
onde ${\bf J}_0$ % = {\bf J}({\bf q}_0)$
é calculada a partir de um vetor fixo %${\bf q}_0$ 
de variáveis não nulas de juntas, sendo utilizada para mapear as velocidades das juntas no espaço cartesiano. O termo ${\boldsymbol \omega}_1(s)\in {\mathbb R}^{m \times m}$ determina a largura de banda da lei de cinemática inversa, sendo obtido a partir de restrições dinâmicas do manipulador e da trajetória de referência, e ${\boldsymbol \omega}_2(s)\in {\mathbb R}^{m \times m}$ determina restrições para os atuadores, estabelecendo um limite superior para as velocidades $\dot{\bf q}$ desenvolvidas. 
%
%${\boldsymbol \omega}_1(s)\in {\mathbb R}^{m \times m}$ determines the badnwidth of the inverse kinematics law and is derived from the dynamic constraints of manipulator and the reference trajectory ${\bf x}_d$. ${\boldsymbol \omega}_2 \in {\mathbb R}^{n \times n}$ determines the constraints in the actuators in terms of the upper bound on the velocities $\dot{\bf q}$. Equation (\ref{eq::fikmin}) can be solved for ${\bf K}(s)$ by using standard ${\mathcal H}_\infty$ optimization algorithm.
%
Para a adaptação de ${\bf K}(s)$, a equação (\ref{eq::fikK}) pode ser reescrita no espaço de estado \cite{AP:09}:
%For the adaptation of ${\bf K}(s)$, (\ref{eq::fikK}) can be written in its state-space form which is of the following adaptive form:
%
\begin{equation}
{\bf K}(s): \left\{\begin{array}{ll}
\dot{\bf z} = {\mathcal A}{\bf z} + {\bf e}_v \\
\dot{\bf q} = ({\mathcal D}_{12}^T{\mathcal D}_{12})^{-1}{\bf J}({\bf q}){\mathcal B}^T{\mathcal P}{\mathcal B}{\bf z} \\
\end{array} \right.
\end{equation}
%
%onde 
%
%\begin{equation}
%{\mathcal G} = ({\mathcal D}_{12}^T{\mathcal D}_{12})^{-1}{\mathcal B}^T{\mathcal P}{\mathcal B}
%\end{equation}
%
onde ${\mathcal G} = ({\mathcal D}_{12}^T{\mathcal D}_{12})^{-1}{\mathcal B}^T{\mathcal P}{\mathcal B}$ e ${\bf z} \in {\mathbb R}^m$ corresponde ao vetor de estados do controlador. A matriz $\mathcal P$ é baseada na escolha de ${\bf J}_0$ e as matrizes ${\mathcal A}$,${\mathcal B}$ e ${\mathcal D}_{12}$ são matrizes diagonais dependentes dos parâmetros de desempenho, portanto ${\boldsymbol \omega}_1$ e ${\boldsymbol \omega}_2$. A matriz de transferência ${\boldsymbol \omega}_1(s)$ é diagonal e dada por 
%  
%${\bf J}({\bf q})$ can be computed at every sample time by using current information of ${\bf q}$. The ${\bf z} \in {\mathbb R}^m$ represents the state of the controller, ${\mathcal A},{\mathcal B},{\mathcal D}_{12}$ are diagonal matrices contributed from perfomance weights (${\boldsymbol \omega}_1$, ${\boldsymbol \omega}_2$) and ${\bf e}_v$ is the error as defined in (\ref{eq::fikerror}). ${\boldsymbol \omega}_1(s)$ is a diagonal transfer-function matrix and is given as:
%
\begin{equation}
{\boldsymbol \omega}_1(s) = \frac{b}{s+\alpha}{\bf I}%^{m \times m}
\end{equation}
%
onde $b$ determina a largura de banda da lei de cinemática inversa e $\alpha$ é o ganho de saturação do integrador em baixas frequências. Assim, ${\mathcal A}$ pode ser escrita como 
%where $b$ determines the bandwidth of FIK law and $\alpha$ is the saturation gain of integrator at low frequencies. With this form of ${\boldsymbol \omega}_1(s)$,${\mathcal A}$ transforms to:
%
\begin{equation}
{\mathcal A} = -\alpha {\bf I}%^{m \times m}
\end{equation}
%
%${\boldsymbol \omega}_1(s)$ allows specifying the tracking accuracy and is linked to the dynamics of desired trajectory and it can be specified for eachm-direction independently by setting $b$ and $\alpha$ differently for each direction in ${\boldsymbol \omega}_1(s)$. The actuator constraints are specified in %${\boldsymbol \omega}_2$. This is done for each degree of freedom ($n$).
O termo ${\boldsymbol \omega}_2$ está relacionado às restrições nos atuadores do manipulador e, dada uma velocidade máxima de junta $\omega$, pode ser escirto como
%
\begin{equation}
{\boldsymbol \omega}_2 = \frac{1}{\omega}{\bf I}%^{n \times n}
\end{equation}
%
%where, $\omega$ is the maximum joint rate. The FIK law allows weighing each degree of freedom independently in ${\boldsymbol \omega}_2$
Nota-se que tanto ${\boldsymbol \omega}_1$ e ${\boldsymbol \omega}_2$ podem ser especificados independentemente em cada direção $m$ ou grau de liberdade $n$, respectivamente. 

Apesar de utilizar uma abordagem bastante diferente para solucionar o problema de cinemática inversa, o algoritmo FIK apresenta algumas similaridades com o algoritmo DLS apresentado anteriormente. De fato, semelhanças na estrutura da solução são bem evidentes e, considerando 
%Although FIK law uses a very different approach to solve inverse kinematics however if it is carefully analyzed then similarities can be found in its structure with damped least square inverse kinematics law. By susbtituting:
%
\begin{equation}
{\bf Q} = {\mathcal G}(s{\bf I} - {\mathcal A})^{-1},
\end{equation}
%
a solução apresentada em (\ref{eq::fiklaw}) se torna 
%can be written into a compact form such as:
%
\begin{equation}
\dot{\bf q} = {\bf J}^T{\bf Q}({\bf JJ}^T{\bf Q} + {\bf I})^{-1}{\boldsymbol \nu}.
\end{equation}
%
Nota-se que as soluções (\ref{eq::fiklaw}) e (\ref{eq::dlslaw}) apresentam a mesma estrutura exceto pela diferença entre os termos $\delta$ e ${\bf Q}$. A solução proposta pelo método FIK utiliza uma função dinâmica de mapeamento ${\bf Q}(s)$ e considera $\delta = 1$, não exigindo portanto o cálculo dos valores singulares da matriz Jacobiana. Em comparação com o algoritmo DLS, o método FIK proporciona robustez a singularidades devido à forma não-diagonal e dinâmica de ${\bf Q}(s)$.
%
%By comparing (\ref{eq::fiklaw}) with (\ref{eq:dlslaw}), it can be observed that both have the same structure except the difference between $\lambda$ and ${\bf Q}$. Instead of using any damping factor $\lambda$, the FIK law uses a dynamic mapping function ${\bf Q}(s)$ in (\ref{eq::fiklaw}). In toher words in FIK law $\lambda = 1$, therefore, there is no need of computation of singular value decomposition of Jacobian. In comparison to the damped least square methods, the FIK method provides singularity robustness due to non-diagonal and dynamic form of ${\bf Q}(s)$.
%
As velocidades das juntas $\dot{\bf q}$ estão relacionadas às velocidades demandadas no espaço cartesiano através da função de controle ${\bf J}^T{\bf Q}({\bf JJ}^T{\bf Q} + {\bf I})^{-1}$ e, uma vez que a solução é obtida através de um laço de realimentação, não é necessária a inversão da matriz Jacobiana. Desta forma, o custo computacional do método é reduzido consideravelmente.
%
%Due to the use of feedback loop in FIK, the joint velocities are related to demanded Cartesian velocities through control sensitive function ${\bf J}^T{\bf Q}({\bf JJ}^T{\bf Q} + {\bf I})^{-1}$ as shown in (\ref{eq::fiklaw}) and since the computation is done in feedback loop it does not require computing inverse of the Jacobian. As a conseguence, computational demand is reduced to a great extent. 
%
De (\ref{eq::fiklaw}), a estabilidade da solução FIK é garantida desde que
%From (\ref{eq::fiklaw}), the stability of FIK law is guaranteed as long as:
%
\begin{equation}
\det({\bf JJ}^T{\bf Q} + {\bf I}) \neq 0.
\end{equation}
%
Isto é, para todas as configurações ${\bf q}$, %a seguinte 
a igualdade %deve ser verificada: 
%In other words, for all combinations in $q$ for any singular value the following must hold true:
%
%\begin{equation}
$\sigma({\bf JJ}^T{\bf Q})\geq0$
%\end{equation}
%
deve ser verificada.
Uma vez que ${\bf Q} = {\mathbf Q}^T \geq {\bf 0}$, este requisito é sempre satisfeito e não depende de ${\bf q}$.

O algoritmo FIK permite a utilização de um vetor de velocidades arbitrárias das juntas $\dot{\bf q}_o$ para satisfazer uma restrição adicional ao sistema redundante \cite{P:08}, similar a (\ref{eq:u2}). O diagrama de blocos aumentado é apresentado na Figura \ref{fig::fikplus}.
\vskip 0.13cm

\begin{figure}[htpb]
  \centering
  \def\JPicScale{0.85}
  {\small
  \input{fig/FIK_2.pst}
  }
  \caption{Diagrama de blocos FIK com restrição adicional}
  \label{fig::fikplus}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% simulacoes
\begin{simulation}
\label{sim::dlsfik5} 
\end{simulation}
\noindent Considere o manipulador planar redundante apresentado na Figura \ref{fig::red} e, inicialmente, uma trajetória livre e afastada de singularidades  (\nameref{traj2}). No que se segue são apresentados os resultados obtidos por simulação para os métodos DLS e FIK. Os ganhos de controle e parâmetros de simulação são obtidos de \cite{NH:86} e \cite{P:08}.% ($\omega_o = 1$, $\alpha_0 = 0.3$ e ${\bf K}(s)\,=\,{\bf J}^T

\begin{figure}[!htp]
  \centering
			\includegraphics[trim = 2.7cm 0cm 2.7cm 0.8cm, scale = 0.46]{sim/sim5_data.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik5}: (a) trajetórias; (b) norma do erro; e (c) condicionamento}
\label{fig::dlsfik5_1}
\end{figure}

Ambos os algoritmos permitem o rastreamento da trajetória desejada. Para o algoritmo DLS, tem-se que $\delta = 0\,,\, \forall t$, uma vez que a trajetória esta afastada da região de pouca manipulabilidade definida por $\omega_o$, e $\lim_{t\to\infty}{\bf e}(t)={\bf 0}$.

\begin{figure}[!htp]
  		\includegraphics[trim = 1.7cm 1.5cm 4.4cm 0cm, scale = 0.46]{sim/sim5_data2.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik5}: variáveis (a) $\dot{\bf q}_{DLS}$; (b) ${\bf q}_{DLS}$; (c) $\dot{\bf q}_{FIK}$; e (d) ${\bf q}_{FIK}$}
\label{fig::dlsfik5_2}
\end{figure}














%%%%%%%%%%%%%%%%%%%%%%%%%% 2

\begin{simulation}
\label{sim::dlsfik3} 
\end{simulation}
\noindent Considere agora uma trajetória de referência que se aproxima de uma configuração singular (\nameref{traj3}). A seguir, são apresentados os resultados de simulação obtidos para os mesmos parâmetros de simulação considerados anteriormente. 

\begin{figure}[!htp]
  \centering
			\includegraphics[trim = 2.7cm 0cm 2.7cm 0.8cm, scale = 0.46]{sim/sim3_data.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik3}: (a) trajetórias; (b) norma do erro; e (c) condicionamento}
\label{fig::dlsfik3_1}
\end{figure}

A partir da Figura \ref{fig::dlsfik3_1}.c, nota-se que, para $t \approx 26s$, a trajetória desejada se aproxima da origem e os algoritmos conseguem evitar esta configuração singular. 

\begin{figure}[!htp]
  		\includegraphics[trim = 1.7cm 1.5cm 4.4cm 0cm, scale = 0.46]{sim/sim3_data2.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik3}: variáveis (a) $\dot{\bf q}_{DLS}$; (b) ${\bf q}_{DLS}$; (c) $\dot{\bf q}_{FIK}$; e (d) ${\bf q}_{FIK}$}
\label{fig::dlsfik3_2}
\end{figure}

Como visto nas Figuras \ref{fig::dlsfik3_2}.a e \ref{fig::dlsfik3_2}.c, ambos algoritmos mantêm as velocidades $\dot{\bf q}$ das juntas numa região adequada, abaixo de 1.2 rad/s. 


















%%%%%%%%%%%%%%%%%%%%%%% 3

\newpage
\begin{simulation}
\label{sim::dlsfik6} 
\end{simulation}
\noindent Neste caso, considera-se uma trajetória que se inicia (${\bf q}(0) = [\frac{\pi}{2}\;0\;0])$ e que passa por uma configuração singular  (\nameref{traj4}).

\begin{figure}[!htp]
  \centering
			\includegraphics[trim = 2.7cm 0.2cm 2.7cm 0.8cm, scale = 0.46]{sim/sim6_data.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik6}: (a) trajetórias; (b) norma do erro; e (c) condicionamento}
\label{fig::dlsfik6_1}
\end{figure}

Uma vez que a postura inicial configura uma singularidade cinemática, todo sinal de velocidade na direção degenerada será anulado pelo algoritmo DLS e este se torna incapaz de alterar a configuração do manipulador. Por outro lado, o algoritmo FIK permite alterar a configuração inicial do manipulador, dado o formato não-diagonal da matriz ${\mathcal G}$, e mantém o erro de rastreamento pequeno ao longo da trajetória.
  
\begin{figure}[!htp]
  		\includegraphics[trim = 1.7cm 1.7cm 4.4cm 0cm, scale = 0.46]{sim/sim6_data2.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik6}: variáveis (a) $\dot{\bf q}_{DLS}$; (b) ${\bf q}_{DLS}$; (c) $\dot{\bf q}_{FIK}$; e (d) ${\bf q}_{FIK}$}
\label{fig::dlsfik6_2}
\end{figure}


\newpage
\begin{simulation}
\label{sim::dlsfik4} 
\end{simulation}
\noindent Considere novamente a \nameref{traj4}. Para uma configuração inicial ${\bf q}(0) = [\frac{\pi}{2}\;\frac{1}{10}\;\frac{1}{10}]$, não singular, o desempenho dos algoritmos é novamente comparado.

\begin{figure}[!htp]
  \centering
			\includegraphics[trim = 2.7cm 0.2cm 2.7cm 0.8cm, scale = 0.46]{sim/sim4_data.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik4}: (a) trajetórias; (b) norma do erro; e (c) condicionamento}
\label{fig::dlsfik4_1}
\end{figure}

Nota-se que, para uma configuração inicial não singular, o algoritmo DLS é capaz de rastrear a trajetória com erro nulo quando afastado da singularidade e permite, na vizinhança desta, o desvio da trajetória (Figuras \ref{fig::dlsfik4_1}.a e \ref{fig::dlsfik4_1}.b).
   
\begin{figure}[!htp]
  		\includegraphics[trim = 1.7cm 1.7cm 4.4cm 0cm, scale = 0.46]{sim/sim4_data2.eps}\\ %\tiny{\,(b)} \\
\caption{Simulação \ref{sim::dlsfik4}: variáveis (a) $\dot{\bf q}_{DLS}$; (b) ${\bf q}_{DLS}$; (c) $\dot{\bf q}_{FIK}$; e (d) ${\bf q}_{FIK}$}
\label{fig::dlsfik4_2}
\end{figure}

Novamente, os algoritmos DLS e FIK mantêm o vetor de velocidades $\dot{\bf q}$ numa faixa adequada, abaixo de 0.7 rad/s, como visto nas Figuras \ref{fig::dlsfik4_2}.a e \ref{fig::dlsfik4_2}.c.




